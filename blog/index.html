<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="stylesheet" href="../static/style.css">
  <link rel="stylesheet" href="../static/pygments.css">
  <title>Blog — mkelly.me</title>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-48282608-1', 'auto');
    ga('send', 'pageview');

  </script>
</head>
<body>
  <header>
    <span class="avatar"></span>
    <h1>Michael Kelly</h1>
    <nav>
      <ul class="nav navbar-nav">
        <li >
          <a href="../">About</a>
        </li>
        <li  class="active">
          <a href="../blog/">Blog</a>
        </li>
        <li><a href="https://twitter.com/osmose">@Osmose</a></li>
        <li><a href="https://github.com/osmose/">Github</a></li>
      </ul>
    </nav>
  </header>
  <div class="page">
    
  
    
  <div class="blog-post">
  
    <h2 class="blog-title"><a href="../blog/phaser-tiled-json-external-loader/">External Tilesets with Tiled and Phaser</a></h2>
  
  <div class="meta">
    <span>
      <i class="octicon octicon-calendar"></i>
      March 3, 2019
    </span>
    <span>
      <i class="octicon octicon-tag"></i>
      phaser gamedev
    </span>
  </div>
  <p><a href="https://www.mapeditor.org/">Tiled</a> is a popular tilemap editor, and <a href="https://phaser.io/">Phaser</a> has great built-in support for it. One feature of Tiled that Phaser <em>doesn't</em> support is external tilesets.</p>
<p>In Tiled, a tileset can either be internal, meaning all the data for the tileset is included in the tilemap itself, or external, meaning that the tileset is a standalone file separate from the tilemap. The main benefit of external tilesets is that they can be shared between maps. You can update and change the tileset without having to update per-tilemap copies everywhere.</p>
<p>Phaser, however, requires that tilesets be stored internally in the tilemaps they're used in. I finally ran into a point where I wanted multiple tilemaps in my game and wrote a custom loader that supports external tilesets.</p>
<p>It's called <a href="https://github.com/Osmose/phaser-tiled-json-external-loader"><code>phaser-tiled-json-external-loader</code></a>, and you can install it via <a href="https://www.npmjs.com/package/phaser-tiled-json-external-loader">NPM</a> or manually download a <a href="https://github.com/Osmose/phaser-tiled-json-external-loader/releases">JavaScript bundle</a> to load in your game's HTML file. The <a href="https://github.com/Osmose/phaser-tiled-json-external-loader#phaser-tiled-json-external-loader">README</a> has more information on how to install and use the library. I've also got a <a href="https://glitch.com/">Glitch</a> project showing the library in action:</p>
<div class="glitch-embed-wrap">
  <iframe
    allow="geolocation; microphone; camera; midi; encrypted-media"
    src="https://glitch.com/embed/#!/embed/phaser-tiled-json-external-loader-example?path=public/client.js&previewSize=27"
    alt="phaser-tiled-json-external-loader-example on Glitch"
    style="height: 100%; width: 100%; border: 0;">
  </iframe>
</div><h3>Why doesn't Phaser support external tilesets?</h3>
<p>I can only speculate based on the code<sup class="footnote-ref" id="fnref-1"><a href="#fn-1" rel="footnote">1</a></sup>. Phaser loads tilemaps as JSON, and doesn't actually parse that JSON until you attempt to create a tilemap object during a scene's <code>create</code> phase. While parsing the Tiled JSON, it <a href="https://github.com/photonstorm/phaser/blob/c85648e06a7bf1de830acb5162dd6705f98ae947/src/tilemaps/parsers/tiled/ParseTilesets.js#L35">tries to load each tileset</a>:</p>
<div class="highlight"><pre><span></span><span class="c1">//  name, firstgid, width, height, margin, spacing, properties</span>
<span class="kd">var</span> <span class="nx">set</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">tilesets</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">set</span><span class="p">.</span><span class="nx">source</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;Phaser can\&#39;t load external tilesets. Use the Embed Tileset button and then export the map again.&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>At this point, we're past the <code>preload</code> step of the scene, and the API for creating tilemaps isn't asynchronous, so going back and loading another external JSON file isn't really an option at this point.</p>
<p>IMO a "proper" fix would be similar to how the images for tilemaps are handled. Even with internal tilesets, the images used in the tilesets must be loaded separately and passed when creating a tileset:</p>
<div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">scene</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">preload</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// The tileset image is not automagically loaded by Phaser</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">image</span><span class="p">(</span><span class="s1">&#39;tilesetImage&#39;</span><span class="p">,</span> <span class="s1">&#39;https://cdn.glitch.com/1780c601-5e7d-42f6-8757-c55452affe65%2Ftiles.png?1551608607854&#39;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">tilemapTiled</span><span class="p">(</span><span class="s1">&#39;tilemap&#39;</span><span class="p">,</span> <span class="s1">&#39;tilemap.json&#39;</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="nx">create</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">tilemap</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">make</span><span class="p">.</span><span class="nx">tilemap</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="s1">&#39;tilemap&#39;</span><span class="p">});</span>
    <span class="c1">// tilesetImage here is referring to the manually-loaded tileset image above</span>
    <span class="kr">const</span> <span class="nx">tileset</span> <span class="o">=</span> <span class="nx">tilemap</span><span class="p">.</span><span class="nx">addTilesetImage</span><span class="p">(</span><span class="s1">&#39;tiles&#39;</span><span class="p">,</span> <span class="s1">&#39;tilesetImage&#39;</span><span class="p">);</span>
    <span class="nx">tilemap</span><span class="p">.</span><span class="nx">createStaticLayer</span><span class="p">(</span><span class="s1">&#39;layer1&#39;</span><span class="p">,</span> <span class="nx">tileset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">},</span>
<span class="p">};</span>
</pre></div>
<p>Similarly, external tilesets should probably be a new type of thing that you could load in the <code>preload</code> step and associate with one (or many) tilemaps.</p>
<p>I tried to figure out how to write a patch like this to fix Phaser directly, but there are multiple types of tilemaps and tilesets supported in Phaser, and I don't really understand the internals well enough yet.</p>
<h3>So how does the loader work?</h3>
<p>So if Phaser only supports internal tilesets, and doesn't parse the tilemap until the <code>create</code> step, what if we loaded and inserted the external tilesets <em>into</em> our tilemaps before Phaser tried parsing them? Some people on the Phaser Discord recommend I write a preprocessor to do this (as they had been doing for a while), but I wanted to build something a bit more broadly reusable.</p>
<p>I spent a few hours reading the code for how loaders work in Phaser and found out that there are things called <a href="https://github.com/photonstorm/phaser/blob/c85648e06a7bf1de830acb5162dd6705f98ae947/src/loader/MultiFile.js">MultiFile loaders</a> that support loading dependent files based on the contents of a manifest-like file. Using the <a href="https://github.com/photonstorm/phaser/blob/c85648e06a7bf1de830acb5162dd6705f98ae947/src/loader/filetypes/MultiAtlasFile.js">MutliAtlasFile loader</a> as a based, I wrote a new loader that:</p>
<ol>
<li>Loads the tilemap JSON</li>
<li>Finds all tilesets that have a <code>source</code> property</li>
<li>Processes each <code>source</code> property as relative to the tilemap's URL to get the URL for each tileset</li>
<li>Loads each external tileset</li>
<li>Inserts each loaded tileset back into the tilemap JSON</li>
<li>Adds the modified tilemap JSON into the tilemap cache</li>
</ol>
<p>I tested with my own game and it seemed to work fine. The remaining steps were to add a webpage-ready bundle for projects that aren't using NPM or a JavaScript bundler, write instructions, and publish the package on NPM.</p>
<h3>Caveats</h3>
<p>There's still some caveats to this method of loading external tilesets:</p>
<ul>
<li><p>Tilesets are duplicated between tilemaps in memory. Sharing references to tilesets would require some more complex coordination in the loader, or a more detailed refactor of how Phaser handles tilesets.</p>
</li>
<li><p>I don't actually know if Phaser will avoid re-requesting a tileset if it is referenced by more than one tilemap. Presumably the browser will cache the request, at least.</p>
</li>
<li><p>The loader is limited to JSON tilemaps and tilesets. TMX formatted tilesets are not supported.</p>
</li>
</ul>
<p>But it works for me and I did it for free so whooooooooooo caressssssss</p>
<div class="footnotes">
<hr>
<ol><li id="fn-1"><p>I mean I actually could just ask the maintainer if I really wanted to.<a href="#fnref-1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

  </div>

  
    
  <div class="blog-post">
  
    <h2 class="blog-title"><a href="../blog/phaser-finite-state-machine/">Phaser Tutorial Series: Finite State Machine</a></h2>
  
  <div class="meta">
    <span>
      <i class="octicon octicon-calendar"></i>
      February 23, 2019
    </span>
    <span>
      <i class="octicon octicon-tag"></i>
      mozilla phaser gamedev
    </span>
  </div>
  <p>I've been working on a game using <a href="https://phaser.io/">Phaser</a> in my spare time:</p>
<div style="position:relative; padding-bottom:calc(84.58% + 44px)"><iframe src="https://gfycat.com/ifr/DentalMasculineFirebelliedtoad" frameborder="0" scrolling="no" width="100%" height="100%" style="position:absolute;top:0;left:0;" allowfullscreen></iframe></div><p>One thing that's made adding new features really easy is using finite-state machines to model behavior. Almost everything in the animation above is backed by a state machine: the player, the platform, the grappling hook, the statue, and the fireballs.</p>
<p>This post is going to assume some familiarity with the basics of Phaser, such as the <code>preload</code>/<code>create</code>/<code>update</code> steps, Arcade physics, and keyboard input. You may also be able to follow along if you're not familiar with Phaser, but it's okay if not! This use of state machines isn't specific to Phaser.</p>
<h3><strike>What is a finite-state machine?</strike> Fuck that let's make games</h3>
<p>Let's start with a fairly empty example project. Here it is on <a href="https://glitch.com/">Glitch</a>. You can use the remix button to create your own copy and follow along the tutorial as we go:</p>
<div class="glitch-embed-wrap">
  <iframe
    allow="geolocation; microphone; camera; midi; encrypted-media"
    src="https://glitch.com/embed/#!/embed/phaser-fsm-example-starter?path=public/client.js&previewSize=40"
    alt="phaser-fsm-example-starter on Glitch"
    style="height: 100%; width: 100%; border: 0;">
  </iframe>
</div><p>Pretty much all of our work is happening in <code>client.js</code>. It starts out looking something like this:</p>
<div class="highlight"><pre><span></span><span class="cm">/* global Phaser */</span>

<span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">type</span><span class="o">:</span> <span class="nx">Phaser</span><span class="p">.</span><span class="nx">AUTO</span><span class="p">,</span>
  <span class="nx">width</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
  <span class="nx">height</span><span class="o">:</span> <span class="mi">300</span><span class="p">,</span>
  <span class="nx">pixelArt</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">zoom</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">physics</span><span class="o">:</span> <span class="p">{</span>
    <span class="k">default</span><span class="o">:</span> <span class="s1">&#39;arcade&#39;</span>
  <span class="p">},</span>
  <span class="nx">scene</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">preload</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">spritesheet</span><span class="p">(</span><span class="s1">&#39;hero&#39;</span><span class="p">,</span> <span class="s1">&#39;https://cdn.glitch.com/59aa1c5f-c16d-41a1-bfd2-09072e84a538%2Fhero.png?1551136698770&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">frameWidth</span><span class="o">:</span> <span class="mi">32</span><span class="p">,</span>
        <span class="nx">frameHeight</span><span class="o">:</span> <span class="mi">32</span><span class="p">,</span>
      <span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">image</span><span class="p">(</span><span class="s1">&#39;bg&#39;</span><span class="p">,</span> <span class="s1">&#39;https://cdn.glitch.com/59aa1c5f-c16d-41a1-bfd2-09072e84a538%2Fbg.png?1551136995353&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">create</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Static background</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">.</span><span class="nx">image</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="s1">&#39;bg&#39;</span><span class="p">);</span>

      <span class="c1">// The movable character</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">hero</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">physics</span><span class="p">.</span><span class="nx">add</span><span class="p">.</span><span class="nx">sprite</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="s1">&#39;hero&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">update</span><span class="p">()</span> <span class="p">{</span>

    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">game</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Phaser</span><span class="p">.</span><span class="nx">Game</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</pre></div>
<p>We're loading some images in the <code>preload</code> step, and adding the background and hero sprite in the <code>create</code> step. The hero is drawn on the background, but nothing else happens.</p>
<h3>MAKE IT WALK</h3>
<p>Let's add a <code>this.keys</code> variable for reading input from the keyboard. We can use that in the <code>update</code> method to check which keys are being pressed and set the hero's velocity appropriately:</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -19,6 +19,8 @@</span>
     },

     create() {
<span class="gi">+      this.keys = this.input.keyboard.createCursorKeys();</span>
<span class="gi">+</span>
       // Static background
       this.add.image(200, 200, &#39;bg&#39;);

<span class="gu">@@ -27,7 +29,20 @@</span>
     },

     update() {
<span class="gd">-</span>
<span class="gi">+      // Stop movement from last update</span>
<span class="gi">+      this.hero.setVelocity(0);</span>
<span class="gi">+</span>
<span class="gi">+      // Set new velocity based on input</span>
<span class="gi">+      if (this.keys.up.isDown) {</span>
<span class="gi">+        this.hero.setVelocityY(-100);</span>
<span class="gi">+      } else if (this.keys.down.isDown) {</span>
<span class="gi">+        this.hero.setVelocityY(100);</span>
<span class="gi">+      }</span>
<span class="gi">+      if (this.keys.left.isDown) {</span>
<span class="gi">+        this.hero.setVelocityX(-100);</span>
<span class="gi">+      } else if (this.keys.right.isDown) {</span>
<span class="gi">+        this.hero.setVelocityX(100);</span>
<span class="gi">+      }</span>
     },
   }
 };
</pre></div>
<h3>MAKE IT LOOK LIKE IT'S WALKING</h3>
<p>Now the hero is moving about the map, but it doesn't look like he's walking. To do that, we'll need to do two things:</p>
<ol>
<li>Define some animations from our sprite sheet in the <code>create</code> function. Our sheet is split into 32x32 pixel squares, so we can use <code>generateFrameNumbers</code> to generate animation data by giving it start and end indexes for the animation frames. These are numbered from top left to bottom right.</li>
<li>Trigger the proper animations in the <code>update</code> function. We also track whether the player is moving or not, and if they aren't, we stop the current animation to stop the player from walking. Note the <code>true</code> passed to the <code>play</code> function: this tells Phaser to not restart the animation if it's already playing.</li>
</ol>
<div class="highlight"><pre><span></span><span class="gu">@@ -26,22 +26,61 @@</span>

       // The movable character
       this.hero = this.physics.add.sprite(200, 150, &#39;hero&#39;, 0);
<span class="gi">+</span>
<span class="gi">+      // Animation definitions</span>
<span class="gi">+      this.anims.create({</span>
<span class="gi">+        key: &#39;walk-down&#39;,</span>
<span class="gi">+        frameRate: 8,</span>
<span class="gi">+        repeat: -1,</span>
<span class="gi">+        frames: this.anims.generateFrameNumbers(&#39;hero&#39;, {start: 0, end: 3}),</span>
<span class="gi">+      });</span>
<span class="gi">+      this.anims.create({</span>
<span class="gi">+        key: &#39;walk-right&#39;,</span>
<span class="gi">+        frameRate: 8,</span>
<span class="gi">+        repeat: -1,</span>
<span class="gi">+        frames: this.anims.generateFrameNumbers(&#39;hero&#39;, {start: 4, end: 7}),</span>
<span class="gi">+      });</span>
<span class="gi">+      this.anims.create({</span>
<span class="gi">+        key: &#39;walk-up&#39;,</span>
<span class="gi">+        frameRate: 8,</span>
<span class="gi">+        repeat: -1,</span>
<span class="gi">+        frames: this.anims.generateFrameNumbers(&#39;hero&#39;, {start: 8, end: 11}),</span>
<span class="gi">+      });</span>
<span class="gi">+      this.anims.create({</span>
<span class="gi">+        key: &#39;walk-left&#39;,</span>
<span class="gi">+        frameRate: 8,</span>
<span class="gi">+        repeat: -1,</span>
<span class="gi">+        frames: this.anims.generateFrameNumbers(&#39;hero&#39;, {start: 12, end: 15}),</span>
<span class="gi">+      });</span>
     },

     update() {
       // Stop movement from last update
<span class="gi">+      let moving = false;</span>
       this.hero.setVelocity(0);

       // Set new velocity based on input
       if (this.keys.up.isDown) {
         this.hero.setVelocityY(-100);
<span class="gi">+        this.hero.anims.play(&#39;walk-up&#39;, true);</span>
<span class="gi">+        moving = true;</span>
       } else if (this.keys.down.isDown) {
         this.hero.setVelocityY(100);
<span class="gi">+        this.hero.anims.play(&#39;walk-down&#39;, true);</span>
<span class="gi">+        moving = true;</span>
       }
       if (this.keys.left.isDown) {
         this.hero.setVelocityX(-100);
<span class="gi">+        this.hero.anims.play(&#39;walk-left&#39;, true);</span>
<span class="gi">+        moving = true;</span>
       } else if (this.keys.right.isDown) {
         this.hero.setVelocityX(100);
<span class="gi">+        this.hero.anims.play(&#39;walk-right&#39;, true);</span>
<span class="gi">+        moving = true;</span>
<span class="gi">+      }</span>
<span class="gi">+</span>
<span class="gi">+      if (!moving) {</span>
<span class="gi">+        this.hero.anims.stop();</span>
       }
     },
   }
</pre></div>
<h3>MAKE IT UNNECESSARILY VIOLENT</h3>
<p>Next, let's make the player swing their sword when we press the space key. This actually involves a few steps:</p>
<ol>
<li>Check if the space key is pressed.</li>
<li><p>Stop player movement while the sword is being swung.</p>
<p>We'll need to know if the hero is currently swinging their sword, so we'll add a <code>swinging</code> variable on <code>this.hero</code> that determines if the swinging animation is still playing.</p>
</li>
<li><p>Determine which direction the player is facing.</p>
<p>Figuring out the direction requires that we add a new variable called <code>direction</code> to keep track between walking and swinging. Storing this on the <code>this.hero</code> object makes it clear that the direction isn't for, say, an enemy we may add later.</p>
</li>
<li>Play the sword-swinging animation for the appropriate direction.</li>
<li>Once the animation is done playing, switch back to the non-sword-swinging sprites and allow movement again.</li>
</ol>
<p>Doing all of this with the movement code is tricky, and difficult to split into single code changes. You may want to take a bit to look over the diff to understand the changes:</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -26,6 +26,8 @@</span>

       // The movable character
       this.hero = this.physics.add.sprite(200, 150, &#39;hero&#39;, 0);
<span class="gi">+      this.hero.direction = &#39;down&#39;;</span>
<span class="gi">+      this.hero.swinging = false;</span>

       // Animation definitions
       this.anims.create({
<span class="gu">@@ -52,6 +54,32 @@</span>
         repeat: -1,
         frames: this.anims.generateFrameNumbers(&#39;hero&#39;, {start: 12, end: 15}),
       });
<span class="gi">+</span>
<span class="gi">+      // NOTE: Sword animations do not repeat</span>
<span class="gi">+      this.anims.create({</span>
<span class="gi">+        key: &#39;swing-down&#39;,</span>
<span class="gi">+        frameRate: 8,</span>
<span class="gi">+        repeat: 0,</span>
<span class="gi">+        frames: this.anims.generateFrameNumbers(&#39;hero&#39;, {start: 16, end: 19}),</span>
<span class="gi">+      });</span>
<span class="gi">+      this.anims.create({</span>
<span class="gi">+        key: &#39;swing-up&#39;,</span>
<span class="gi">+        frameRate: 8,</span>
<span class="gi">+        repeat: 0,</span>
<span class="gi">+        frames: this.anims.generateFrameNumbers(&#39;hero&#39;, {start: 20, end: 23}),</span>
<span class="gi">+      });</span>
<span class="gi">+      this.anims.create({</span>
<span class="gi">+        key: &#39;swing-right&#39;,</span>
<span class="gi">+        frameRate: 8,</span>
<span class="gi">+        repeat: 0,</span>
<span class="gi">+        frames: this.anims.generateFrameNumbers(&#39;hero&#39;, {start: 24, end: 27}),</span>
<span class="gi">+      });</span>
<span class="gi">+      this.anims.create({</span>
<span class="gi">+        key: &#39;swing-left&#39;,</span>
<span class="gi">+        frameRate: 8,</span>
<span class="gi">+        repeat: 0,</span>
<span class="gi">+        frames: this.anims.generateFrameNumbers(&#39;hero&#39;, {start: 28, end: 31}),</span>
<span class="gi">+      });</span>
     },

     update() {
<span class="gu">@@ -59,28 +87,43 @@</span>
       let moving = false;
       this.hero.setVelocity(0);

<span class="gd">-      // Set new velocity based on input</span>
<span class="gd">-      if (this.keys.up.isDown) {</span>
<span class="gd">-        this.hero.setVelocityY(-100);</span>
<span class="gd">-        this.hero.anims.play(&#39;walk-up&#39;, true);</span>
<span class="gd">-        moving = true;</span>
<span class="gd">-      } else if (this.keys.down.isDown) {</span>
<span class="gd">-        this.hero.setVelocityY(100);</span>
<span class="gd">-        this.hero.anims.play(&#39;walk-down&#39;, true);</span>
<span class="gd">-        moving = true;</span>
<span class="gd">-      }</span>
<span class="gd">-      if (this.keys.left.isDown) {</span>
<span class="gd">-        this.hero.setVelocityX(-100);</span>
<span class="gd">-        this.hero.anims.play(&#39;walk-left&#39;, true);</span>
<span class="gd">-        moving = true;</span>
<span class="gd">-      } else if (this.keys.right.isDown) {</span>
<span class="gd">-        this.hero.setVelocityX(100);</span>
<span class="gd">-        this.hero.anims.play(&#39;walk-right&#39;, true);</span>
<span class="gd">-        moving = true;</span>
<span class="gd">-      }</span>
<span class="gd">-</span>
<span class="gd">-      if (!moving) {</span>
<span class="gd">-        this.hero.anims.stop();</span>
<span class="gi">+      // If we&#39;re swinging a sword, wait for the animation to finish</span>
<span class="gi">+      if (!this.hero.swinging) {</span>
<span class="gi">+        // Swinging a sword overrides movement</span>
<span class="gi">+        if (this.keys.space.isDown) {</span>
<span class="gi">+          this.hero.swinging = true;</span>
<span class="gi">+          this.hero.anims.play(`swing-${this.hero.direction}`, true);</span>
<span class="gi">+          this.hero.once(&#39;animationcomplete&#39;, () =&gt; {</span>
<span class="gi">+            this.hero.anims.play(`walk-${this.hero.direction}`, true);</span>
<span class="gi">+            this.hero.swinging = false;</span>
<span class="gi">+          });</span>
<span class="gi">+        } else {</span>
<span class="gi">+          // Set new velocity based on input</span>
<span class="gi">+          if (this.keys.up.isDown) {</span>
<span class="gi">+            this.hero.setVelocityY(-100);</span>
<span class="gi">+            this.hero.direction = &#39;up&#39;;</span>
<span class="gi">+            moving = true;</span>
<span class="gi">+          } else if (this.keys.down.isDown) {</span>
<span class="gi">+            this.hero.setVelocityY(100);</span>
<span class="gi">+            this.hero.direction = &#39;down&#39;;</span>
<span class="gi">+            moving = true;</span>
<span class="gi">+          }</span>
<span class="gi">+          if (this.keys.left.isDown) {</span>
<span class="gi">+            this.hero.setVelocityX(-100);</span>
<span class="gi">+            this.hero.direction = &#39;left&#39;;</span>
<span class="gi">+            moving = true;</span>
<span class="gi">+          } else if (this.keys.right.isDown) {</span>
<span class="gi">+            this.hero.setVelocityX(100);</span>
<span class="gi">+            this.hero.direction = &#39;right&#39;;</span>
<span class="gi">+            moving = true;</span>
<span class="gi">+          }</span>
<span class="gi">+</span>
<span class="gi">+          if (!moving) {</span>
<span class="gi">+            this.hero.anims.stop();</span>
<span class="gi">+          } else {</span>
<span class="gi">+            this.hero.anims.play(`walk-${this.hero.direction}`, true);</span>
<span class="gi">+          }</span>
<span class="gi">+        }</span>
       }
     },
   }
</pre></div>
<h3>MAKE IT DO MORE?</h3>
<p>Okay so the hero is now swinging their sword, next we want to add the ability for them to jump, or maybe we want to handle collision detection, or maybe add some enemy logic to the update loop, or... well, you get the idea. We've barely added some basic functionality to the game and already the update loop is getting difficult to manage.</p>
<p>The core problem here is that, to add some new feature to the player, like a new weapon or ability, we need to think about <em>every other thing the player can do</em>. What happens if the player uses a hookshot while moving? What if they use a jump power while moving? One may freeze the player in place while the other retains their momentum. There's too much state to keep in our heads.</p>
<p>Enter state machines. The idea is to model the player's behavior by assigning them a single "state" to be in. When a player is in a "state", they can "transition" to another state if a condition is met, which replaces the current state with a new one. If we design our states and transitions correctly, we can control the amount of info we need to keep in our head when writing new features.</p>
<p>I find the state machine from the <a href="https://en.wikipedia.org/wiki/Finite-state_machine">Wikipedia article on state machines</a> to be a great example:</p>
<figure>
    <img alt="A state machine modelling a turnstile" src="/blog/phaser-finite-state-machine/example-state-machine.svg">
    <figcaption>A state machine diagram for a subway turnstile. The "Locked" state is the initial state.</figcaption>
</figure><p>The diagram above illustrates a subway turnstile that is locked until you drop a coin into it, which unlocks it and allows one person to walk through before becoming locked again. The state machine has two states:</p>
<ul>
<li><strong>Locked</strong>: The turnstile is locked. Pushing it will not let you through and remain in the "Locked" state, but inserting a coin will transition to the "Open" state.</li>
<li><strong>Unlocked</strong>: The turnstile is unlocked. Inserting another coin will keep the turnstile "Unlocked", but pushing it will allow you through and transition back to the "Locked" state.</li>
</ul>
<p>In the same way that this diagram models the behavior of the real turnstile, we can create a similar diagram that models how we want our player to behave:</p>
<figure>
    <img alt="A state machine modelling the hero" src="/blog/phaser-finite-state-machine/hero-state-machine.svg">
    <figcaption>I am not the best diagram-maker.</figcaption>
</figure><p>The entire diagram itself is a little messy, but the point is that this model allows us to implement each state in isolation, resulting in cleaner, easier-to-maintain code.</p>
<h3>Coding a State Machine</h3>
<p>We're going to create a <code>StateMachine</code> class that handles storing the current active state, storing a list of all possible states, and transitioning from the current state to a new state. But transitioning alone doesn't really <em>do</em> anything.</p>
<p>Besides transitioning, we also want to:</p>
<ul>
<li>Run a function when we first transition to a new state. This lets us modify the hero when we transition between states, like starting the attack animation when we enter the <code>swing</code> state. We'll call this the <code>enter</code> function.</li>
<li>Run a function during each <code>update</code> call depending on the current state. We'll call this the <code>execute</code> function.</li>
</ul>
<p>There are several options for how to represent a state in our code. One is to use classes, which allows us to inherit from a base <code>State</code> class to get default <code>enter</code> and <code>execute</code> functions.</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -1,5 +1,46 @@</span>
 /* global Phaser */

<span class="gi">+class StateMachine {</span>
<span class="gi">+  constructor(initialState, possibleStates, stateArgs=[]) {</span>
<span class="gi">+    this.initialState = initialState;</span>
<span class="gi">+    this.possibleStates = possibleStates;</span>
<span class="gi">+    this.stateArgs = stateArgs;</span>
<span class="gi">+    this.state = null;</span>
<span class="gi">+</span>
<span class="gi">+    // State instances get access to the state machine via this.stateMachine.</span>
<span class="gi">+    for (const state of Object.values(this.possibleStates)) {</span>
<span class="gi">+      state.stateMachine = this;</span>
<span class="gi">+    }</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
<span class="gi">+  step() {</span>
<span class="gi">+    // On the first step, the state is null and we need to initialize the first state.</span>
<span class="gi">+    if (this.state === null) {</span>
<span class="gi">+      this.state = this.initialState;</span>
<span class="gi">+      this.possibleStates[this.state].enter(...this.stateArgs);</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    // Run the current state&#39;s execute</span>
<span class="gi">+    this.possibleStates[this.state].execute(...this.stateArgs);</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
<span class="gi">+  transition(newState, ...enterArgs) {</span>
<span class="gi">+    this.state = newState;</span>
<span class="gi">+    this.possibleStates[this.state].enter(...this.stateArgs, ...enterArgs);</span>
<span class="gi">+  }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+class State {</span>
<span class="gi">+  enter() {</span>
<span class="gi">+</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
<span class="gi">+  execute() {</span>
<span class="gi">+</span>
<span class="gi">+  }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+</span>
 const config = {
   type: Phaser.AUTO,
   width: 400,
</pre></div>
<p>There are two things to note in the code above:</p>
<ul>
<li><code>possibleStates</code> is an object whose keys refer to the state name, and whose values are instances of the <code>State</code> class (or subclasses). We assign the <code>stateMachine</code> property on each instance so that they can call <code>this.stateMachine.transition</code> whenever they want to trigger a transition.</li>
<li><code>stateArgs</code> is a list of arguments passed to the <code>enter</code> and <code>execute</code> functions. This lets us pass commonly-used values (such as the hero or the current Phaser scene) to the state methods.</li>
</ul>
<p>With this state machine implementation, we can replace our nest of <code>if</code> statements with classes for each state we modeled on our diagram:</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -27,7 +68,14 @@</span>
       // The movable character
       this.hero = this.physics.add.sprite(200, 150, &#39;hero&#39;, 0);
       this.hero.direction = &#39;down&#39;;
<span class="gd">-      this.hero.swinging = false;</span>
<span class="gi">+</span>
<span class="gi">+      // The state machine managing the hero</span>
<span class="gi">+      this.stateMachine = new StateMachine(&#39;idle&#39;, {</span>
<span class="gi">+        idle: new IdleState(),</span>
<span class="gi">+        move: new MoveState(),</span>
<span class="gi">+        swing: new SwingState(),</span>
<span class="gi">+      }, [this, this.hero]);</span>
<span class="gi">+</span>

       // Animation definitions
       this.anims.create({
<span class="gu">@@ -83,50 +131,79 @@</span>
     },

     update() {
<span class="gd">-      // Stop movement from last update</span>
<span class="gd">-      let moving = false;</span>
<span class="gd">-      this.hero.setVelocity(0);</span>
<span class="gd">-</span>
<span class="gd">-      // If we&#39;re swinging a sword, wait for the animation to finish</span>
<span class="gd">-      if (!this.hero.swinging) {</span>
<span class="gd">-        // Swinging a sword overrides movement</span>
<span class="gd">-        if (this.keys.space.isDown) {</span>
<span class="gd">-          this.hero.swinging = true;</span>
<span class="gd">-          this.hero.anims.play(`swing-${this.hero.direction}`, true);</span>
<span class="gd">-          this.hero.once(&#39;animationcomplete&#39;, () =&gt; {</span>
<span class="gd">-            this.hero.anims.play(`walk-${this.hero.direction}`, true);</span>
<span class="gd">-            this.hero.swinging = false;</span>
<span class="gd">-          });</span>
<span class="gd">-        } else {</span>
<span class="gd">-          // Set new velocity based on input</span>
<span class="gd">-          if (this.keys.up.isDown) {</span>
<span class="gd">-            this.hero.setVelocityY(-100);</span>
<span class="gd">-            this.hero.direction = &#39;up&#39;;</span>
<span class="gd">-            moving = true;</span>
<span class="gd">-          } else if (this.keys.down.isDown) {</span>
<span class="gd">-            this.hero.setVelocityY(100);</span>
<span class="gd">-            this.hero.direction = &#39;down&#39;;</span>
<span class="gd">-            moving = true;</span>
<span class="gd">-          }</span>
<span class="gd">-          if (this.keys.left.isDown) {</span>
<span class="gd">-            this.hero.setVelocityX(-100);</span>
<span class="gd">-            this.hero.direction = &#39;left&#39;;</span>
<span class="gd">-            moving = true;</span>
<span class="gd">-          } else if (this.keys.right.isDown) {</span>
<span class="gd">-            this.hero.setVelocityX(100);</span>
<span class="gd">-            this.hero.direction = &#39;right&#39;;</span>
<span class="gd">-            moving = true;</span>
<span class="gd">-          }</span>
<span class="gd">-</span>
<span class="gd">-          if (!moving) {</span>
<span class="gd">-            this.hero.anims.stop();</span>
<span class="gd">-          } else {</span>
<span class="gd">-            this.hero.anims.play(`walk-${this.hero.direction}`, true);</span>
<span class="gd">-          }</span>
<span class="gd">-        }</span>
<span class="gd">-      }</span>
<span class="gi">+      this.stateMachine.step();</span>
     },
   }
 };

<span class="gi">+class IdleState extends State {</span>
<span class="gi">+  enter(scene, hero) {</span>
<span class="gi">+    hero.setVelocity(0);</span>
<span class="gi">+    hero.anims.play(`walk-${hero.direction}`);</span>
<span class="gi">+    hero.anims.stop();</span>
<span class="gi">+  }</span>
<span class="gi">+</span>
<span class="gi">+  execute(scene, hero) {</span>
<span class="gi">+    const {left, right, up, down, space} = scene.keys;</span>
<span class="gi">+</span>
<span class="gi">+    // Transition to swing if pressing space</span>
<span class="gi">+    if (space.isDown) {</span>
<span class="gi">+      this.stateMachine.transition(&#39;swing&#39;);</span>
<span class="gi">+      return;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    // Transition to move if pressing a movement key</span>
<span class="gi">+    if (left.isDown || right.isDown || up.isDown || down.isDown) {</span>
<span class="gi">+      this.stateMachine.transition(&#39;move&#39;);</span>
<span class="gi">+      return;</span>
<span class="gi">+    }</span>
<span class="gi">+  }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+class MoveState extends State {</span>
<span class="gi">+  execute(scene, hero) {</span>
<span class="gi">+    const {left, right, up, down, space} = scene.keys;</span>
<span class="gi">+</span>
<span class="gi">+    // Transition to swing if pressing space</span>
<span class="gi">+    if (space.isDown) {</span>
<span class="gi">+      this.stateMachine.transition(&#39;swing&#39;);</span>
<span class="gi">+      return;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    // Transition to idle if not pressing movement keys</span>
<span class="gi">+    if (!(left.isDown || right.isDown || up.isDown || down.isDown)) {</span>
<span class="gi">+      this.stateMachine.transition(&#39;idle&#39;);</span>
<span class="gi">+      return;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    hero.setVelocity(0);</span>
<span class="gi">+    if (up.isDown) {</span>
<span class="gi">+      hero.setVelocityY(-100);</span>
<span class="gi">+      hero.direction = &#39;up&#39;;</span>
<span class="gi">+    } else if (down.isDown) {</span>
<span class="gi">+      hero.setVelocityY(100);</span>
<span class="gi">+      hero.direction = &#39;down&#39;;</span>
<span class="gi">+    }</span>
<span class="gi">+    if (left.isDown) {</span>
<span class="gi">+      hero.setVelocityX(-100);</span>
<span class="gi">+      hero.direction = &#39;left&#39;;</span>
<span class="gi">+    } else if (right.isDown) {</span>
<span class="gi">+      hero.setVelocityX(100);</span>
<span class="gi">+      hero.direction = &#39;right&#39;;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    hero.anims.play(`walk-${hero.direction}`, true);</span>
<span class="gi">+  }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+class SwingState extends State {</span>
<span class="gi">+  enter(scene, hero) {</span>
<span class="gi">+    hero.setVelocity(0);</span>
<span class="gi">+    hero.anims.play(`swing-${hero.direction}`);</span>
<span class="gi">+    hero.once(&#39;animationcomplete&#39;, () =&gt; {</span>
<span class="gi">+      this.stateMachine.transition(&#39;idle&#39;);</span>
<span class="gi">+    });</span>
<span class="gi">+  }</span>
<span class="gi">+}</span>
<span class="gi">+</span>
 window.game = new Phaser.Game(config);
</pre></div>
<p>This is a lot to unpack. Some highlights of the changes:</p>
<ul>
<li>We can remove the <code>swinging</code> variable now, as it's been effectively replaced by <code>swing</code> being the current state. Since <code>SwingState</code> doesn't do anything in it's <code>execute</code> function, there's no fear of accidentally moving during the swing.</li>
<li>Note how the transitions from the state machine we modeled above typically appear as early <code>if</code> statements that transition and return if their condition passes.</li>
<li>Some code is repeated, such as checking if the spacebar is being pressed and transitioning to the <code>swing</code> state. You could factor these out to avoid repeated code, but I find that ends up coupling code in a way that is harder to maintain vs keeping them separate.</li>
</ul>
<h3>Okay but why?</h3>
<p>At first glance it may seem that the state machine code is longer than the old <code>update</code> method and more complex, and to some degree this is true. The reduction in complexity is not due to less code, but is instead due to less cognitive load. When we're working on the move state, we don't have to think about interfering with the idle and swing state logic as much as we previously did.</p>
<p>Let's say we want to add a dash in the current direction when the Shift key is pressed. Under the old code, we'd have to figure out where in the nest of <code>if</code> statements to check the shift key, and then probably add another level of conditions to avoid moving or attacking during a dash. With a state machine, we can add a new <code>dash</code> state and modify the existing states that can validly transition to a dash:</p>
<div class="highlight"><pre><span></span><span class="gu">@@ -74,6 +74,7 @@</span>
         idle: new IdleState(),
         move: new MoveState(),
         swing: new SwingState(),
<span class="gi">+        dash: new DashState(),</span>
       }, [this, this.hero]);


<span class="gu">@@ -144,7 +145,7 @@</span>
   }

   execute(scene, hero) {
<span class="gd">-    const {left, right, up, down, space} = scene.keys;</span>
<span class="gi">+    const {left, right, up, down, space, shift} = scene.keys;</span>

     // Transition to swing if pressing space
     if (space.isDown) {
<span class="gu">@@ -152,6 +153,12 @@</span>
       return;
     }

<span class="gi">+    // Transition to dash if pressing shift</span>
<span class="gi">+    if (shift.isDown) {</span>
<span class="gi">+      this.stateMachine.transition(&#39;dash&#39;);</span>
<span class="gi">+      return;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
     // Transition to move if pressing a movement key
     if (left.isDown || right.isDown || up.isDown || down.isDown) {
       this.stateMachine.transition(&#39;move&#39;);
<span class="gu">@@ -162,7 +169,7 @@</span>

 class MoveState extends State {
   execute(scene, hero) {
<span class="gd">-    const {left, right, up, down, space} = scene.keys;</span>
<span class="gi">+    const {left, right, up, down, space, shift} = scene.keys;</span>

     // Transition to swing if pressing space
     if (space.isDown) {
<span class="gu">@@ -170,6 +177,12 @@</span>
       return;
     }

<span class="gi">+    // Transition to dash if pressing shift</span>
<span class="gi">+    if (shift.isDown) {</span>
<span class="gi">+      this.stateMachine.transition(&#39;dash&#39;);</span>
<span class="gi">+      return;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
     // Transition to idle if not pressing movement keys
     if (!(left.isDown || right.isDown || up.isDown || down.isDown)) {
       this.stateMachine.transition(&#39;idle&#39;);
<span class="gu">@@ -204,6 +217,32 @@</span>
       this.stateMachine.transition(&#39;idle&#39;);
     });
   }
<span class="gi">+}</span>
<span class="gi">+</span>
<span class="gi">+class DashState extends State {</span>
<span class="gi">+  enter(scene, hero) {</span>
<span class="gi">+    hero.setVelocity(0);</span>
<span class="gi">+    hero.anims.play(`swing-${hero.direction}`);</span>
<span class="gi">+    switch (hero.direction) {</span>
<span class="gi">+      case &#39;up&#39;:</span>
<span class="gi">+        hero.setVelocityY(-300);</span>
<span class="gi">+        break;</span>
<span class="gi">+      case &#39;down&#39;:</span>
<span class="gi">+        hero.setVelocityY(300);</span>
<span class="gi">+        break;</span>
<span class="gi">+      case &#39;left&#39;:</span>
<span class="gi">+        hero.setVelocityX(-300);</span>
<span class="gi">+        break;</span>
<span class="gi">+      case &#39;right&#39;:</span>
<span class="gi">+        hero.setVelocityX(300);</span>
<span class="gi">+        break;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="gi">+    // Wait a third of a second and then go back to idle</span>
<span class="gi">+    scene.time.delayedCall(300, () =&gt; {</span>
<span class="gi">+      this.stateMachine.transition(&#39;idle&#39;);</span>
<span class="gi">+    });</span>
<span class="gi">+  }</span>
 }

 window.game = new Phaser.Game(config);
</pre></div>
<h3>Is this fast?</h3>
<p>No idea. I haven't hit issues with my own game. I'm not terribly concerned about performance as my game is just a demo right now, so take that with a grain of salt.</p>
<p>I don't think there's any glaring issues with it performance-wise, but I suspect having a bunch of state machines running each update loop might start to cause issues with their overhead. Some clever engineering could reuse states or even state machines between sprites, which might help.</p>
<h3>What else could we do with this?</h3>
<p>There's a lot of ideas I haven't touched upon here that are worth exploring:</p>
<ul>
<li>If states are classes, it stands to reason you can make more than one instance and accept parameters in their constructor.</li>
<li>States could also subclass other states to share common logic or code between them.</li>
<li>In my personal game, there are <code>exit</code> handlers as well as <code>enter</code> ones.</li>
</ul>
<h3>Final Project</h3>
<p>Here's the final version of the code used for this post, available as another Glitch project for your reading and remixing pleasure:</p>
<div class="glitch-embed-wrap">
  <iframe
    allow="geolocation; microphone; camera; midi; encrypted-media"
    src="https://glitch.com/embed/#!/embed/phaser-fsm-example?path=public/client.js&previewSize=40"
    alt="phaser-fsm-example on Glitch"
    style="height: 100%; width: 100%; border: 0;">
  </iframe>
</div>
  </div>

  
    
  <div class="blog-post">
  
    <h2 class="blog-title"><a href="../blog/data-collection-at-mozilla-browser-errors/">Data Collection at Mozilla: Browser Errors</a></h2>
  
  <div class="meta">
    <span>
      <i class="octicon octicon-calendar"></i>
      April 11, 2018
    </span>
    <span>
      <i class="octicon octicon-tag"></i>
      mozilla
    </span>
  </div>
  <p>I’ve spent the past few months working on a project involving data collection from users of Nightly, the pre-release channel of Firefox that updates twice a day. I’d like to share the process from conception to prototype to illustrate</p>
<ol>
<li>One of the many ways ideas become reality at Mozilla, and</li>
<li>How we care about and protect user privacy with regards to data collection.</li>
</ol>
<h2>Maybe JavaScript errors are a bad thing</h2>
<p>The user interface of Firefox is written in JavaScript (along with <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XUL">XUL</a>, HTML, and CSS). JavaScript powering the UI is “privileged” JavaScript, which is separate from JavaScript in a normal webpage, and can do things that normal webpages cannot do, such as read the filesystem.</p>
<p>When something goes wrong and an error occurs in this privileged JavaScript (let’s call them “browser errors”), it ends up logged to the <a href="https://developer.mozilla.org/en-US/docs/Tools/Browser_Console">Browser Console</a>. Most users aren’t looking at the Browser Console, so these errors often go unnoticed.</p>
<p>While working on <a href="https://wiki.mozilla.org/Firefox/Shield">Shield</a>, I found that our QA cycle<sup class="footnote-ref" id="fnref-1"><a href="#fn-1" rel="footnote">1</a></sup> involved a lot of time noticing and reporting errors in the Browser Console. Our code would often land on the <a href="https://www.mozilla.org/en-US/firefox/channel/desktop/">Nightly channel</a> before QA review, so why couldn’t we just catch errors thrown from our code and report them somewhere?<sup class="footnote-ref" id="fnref-2"><a href="#fn-2" rel="footnote">2</a></sup></p>
<h2>So let’s a great plan</h2>
<p>I told my boss a few times that browser error collection was a problem that I was interested in solving. I was pretty convinced that there was useful info to be gleaned from collecting these errors, but my beliefs aren’t really enough to justify building a production-quality error collection service. This was complicated by the fact that errors may contain info that can personally identify a user:</p>
<ul>
<li>There’s no limits or checks on what goes into an error message in Firefox, so we can’t guarantee that error messages don’t contain things like, say, an auth token for a URL that we couldn’t connect to.</li>
<li>Tracebacks for errors may signal that a user was using a specific feature in Firefox, like private browsing. It’s not clear whether “user was using private browsing” is private user data or not, but it’s gray enough to be concerning.</li>
</ul>
<p>On top of all that, we didn’t even know how often these errors were occurring in the wild. Was this a raging fire of constant errors we were just ignoring, or was I getting all worried about nothing?</p>
<p>In the end, I proposed a 3-step research project:</p>
<ol>
<li>Run a study to measure the number of errors occurring in Nightly as well as the distribution of signatures.</li>
<li>Estimate potential load using the study data, and build a prototype service. Grant access to the data to a limited set of employees and discover whether the data helps us find and diagnose errors.</li>
<li>Shut down the prototype after 6 months or so and evaluate if we should build a production version of the system.</li>
</ol>
<p>I wrote up this plan as <a href="https://docs.google.com/document/d/1FAoRLP19hvVFniQniOC9N5jxSUpITCrUs1SiXdhrOEM/edit?usp=sharing">a document</a> that could be shared among people asking why this was an important project to solve. Eventually, my boss threw the idea past Firefox leadership, who agreed that it was a problem worth pursuing.</p>
<h2>What even is happening out there</h2>
<p>The first step was to find out how many errors we’d be collecting. One tool at our disposal at Mozilla is Shield, which lets us run small studies at targeted subsets of users. In this case, I wanted to collect data on how many errors were being logged on the Nightly channel.</p>
<p>To run the study, I had to fill out a <a href="https://docs.google.com/document/d/1iHRNYY9kB8R9ecT4YSMhcDRaJsDzLSKwrJnlsoi_WNA/edit?usp=sharing">Product Hypothesis Document (PHD)</a> describing my experiment. The PHD is approved by a group in Mozilla with data science and experiment design experience. It’s an important step that checks multiple things:</p>
<ul>
<li>Do you know how to interpret the results of your experiment? Is success vs failure clear?</li>
<li>Have you enumerated the user data you’ll need to collect? Mozilla has a classification system for user data that needs to be applied to prevent collection of sensitive data.</li>
<li>Are you sending your experiment to the minimally-effective group? If we can make do with only collecting data from 3000 users rather than 30,000, we should avoid the over-collection of data.</li>
</ul>
<p>Once the PHD was approved, I implemented the code for my study and created a <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1423784">Bugzilla bug</a> for final review. Mozilla has a group of “data stewards” who are responsible for reviewing data collection to ensure it complies with our policies. Studies are not allowed to go out until they’ve been reviewed, and the results of the review are, in most cases, public and available in Bugzilla.</p>
<p>In our case, we decided to compute hashes from the error stacktraces and submit those to Mozilla’s data analysis pipeline. That allowed us to count the number of errors and view the distribution of specific errors without accidentally collecting personal data that may be in file paths.</p>
<h3>I am perfect and infallible</h3>
<p>The last steps after passing review in the bug were to announce the study on a few mailing lists to both solicit feedback from Firefox developers, and to inform our release team that we intended to ship a new study to users. Once the release team approved our launch plan, we launched and started to collect data. Yay!</p>
<p>A few days after launching Ekr, who had noticed the study on the mailing lists, reached out and voiced some concerns with our study.</p>
<p>While we were hashing errors before sending them, an adversary could precompute the hashes by running Firefox, triggering bugs they were interested in, and generating their own hash using the same method we were using. This, paired with direct access to our telemetry data, would reveal that an individual user had run a specific piece of code.</p>
<p>It was unclear if knowing that a user had run a piece of code could be considered sensitive data. If, for example, the error came from code involved with private browsing mode, would that constitute knowing that the user had used private browsing mode for something? Was that sensitive enough for us to not want to collect?</p>
<p>We decided to turn the study off while we tried to address these concerns. By that point, we had collected 2-3 days-worth of data, and decided that the risk wasn’t large enough to justify dropping the data we already had. I was able to perform a limited analysis on that data and determine that we were seeing tens of millions of errors per day, which was enough of an estimate for building the prototype. With that question answered, we opted to keep the study disabled and consider it finished rather than re-tool it based on Ekr’s feedback.</p>
<h2>Can I collect the errors now</h2>
<p>Mozilla already runs our own instance of <a href="https://sentry.io/welcome/">Sentry</a> for collecting and aggregating errors, and I have prior experience with it, so it seemed the obvious choice for the prototype.</p>
<p>With roughly 50 million errors per-day, I figured we could sample sending them to the collection service at a rate of 0.1%, or about 50,000 per-day. The operations team that ran our Sentry instance agreed that an extra 50,000 errors wasn’t an issue.</p>
<p>I spent a few weeks writing up a Firefox patch that collected the errors, mangled them into a Sentry-compatible format, and sent them off. Once the patch was ready, I had to get a technical review from a Firefox peer and a privacy review from a data steward. The patch and review process can be seen in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1426482">the Bugzilla bug</a>.</p>
<p>The process, as outlined on the <a href="https://wiki.mozilla.org/Firefox/Data_Collection">Data Collection wiki page</a>, involves three major steps:</p>
<h3>Requesting Review</h3>
<p>First, I had to fill out a <a href="https://github.com/mozilla/data-review/blob/fde1f65be2cfe8be68a48d307e261d3bd53af09d/request.md">form</a> with several questions asking me to describe the data collection. I’m actually a huge fan of this form, because the questions force you to consider many aspects about data collection that are easy to ignore:</p>
<dl>
    <dt><em>“Why does Mozilla need to answer these questions? Are there benefits for users? Do we need this information to address product or business requirements?”</em></dt>
    <dd>It’s really easy to let curiosity or mild suspicion drive big chunks of work. The point of this question is to force you to think of a reason for doing the collection. Collecting data just because it is mildly convenient or interesting isn’t a good enough reason; it needs a purpose.</dd>

    <dt><em>“What alternative methods did you consider to answer these questions? Why were they not sufficient?”</em></dt>
    <dd>Data collection can’t simply be the first tool you reach for to answer your questions. If we want to be respectful of user privacy, we need to consider other ways of answering questions that don’t involve collecting data.</dd>

    <dt><em>“List all proposed measurements and indicate the category of data collection for each measurement, using the Firefox data collection categories on the Mozilla wiki.”</em></dt>
    <dd>The <a href="">classification system we use for data</a> makes it very clear how to apply our policies to the data you’re collecting. Browser errors, for example, are mostly category 2 data, but may potentially contain category 3 data and as such must be held to a higher standard.</dd>

    <dt><em>“How long will this data be collected?”</em></dt>
    <dd>If we can limit the time period in which we collect a piece of data, we can reduce the impact of data collection on users. I didn’t actually know time-limited collection was something to consider until I saw this question for the first time, but in fact several of our data collection systems enforce time limits by default.</dd>
</dl><h3>Reviewing Request</h3>
<p>Data stewards have their own form to fill out when reviewing a collection request. This form helps stewards be consistent in their judgement. Besides reviewing the answers to the review form from above, reviewers are asked to confirm a few other things:</p>
<dl>
    <dt><em>Is the data collection documented in a publicly accessible place?</em></dt>
    <dd>Sufficiently technical users should be able to see the schema for data being collected without having to read through the Firefox source code. Failing to provide this documentation mandates a failing review.</dd>

    <dt><em>Is there a way for users to disable the collection?</em></dt>
    <dd>There must be some way for users to disable the data collection. Missing this is also considered grounds for failure.
    <br><br>
    It’s important to note that this mechanism doesn’t need to be, say, a checkbox in the preferences UI. Depending on the context of the data collection, an about:config preference or some other mechanism may be good enough.</dd>
</dl><h3>Rereing Viewquest?</h3>
<p>In certain cases, requests may be escalated to Mozilla’s legal team if they involve changes to our privacy policy or other special circumstances. In the case of browser error collection, we wanted a legal review to double-check whether a user having used private browsing mode was considered category 2 or 3 data, as well as to approve our proposal for collecting category 3 data in error messages and file paths.</p>
<p>Our approach was to mimic what Mozilla already does with crashes; we collect the data and restrict access to the data to a subset of employees who are individually approved access. This helps make the data accessible only to people who need it, and their access is contingent on employment<sup class="footnote-ref" id="fnref-3"><a href="#fn-3" rel="footnote">3</a></sup>. Legal approved the plan, which we implemented using built-in Sentry access control.</p>
<h2>Welcome to errortown</h2>
<p>With code and privacy review finished, I landed the patch and waited patiently for Sentry to start receiving errors. And it did!</p>
<p>Since we started receiving the data, I’ve spent most of my time recruiting Firefox developers who want to search through the errors we’re collecting, and refining the data we’re collecting to make it more more useful to those developers. Of course, changes to the data collection require new privacy reviews, although the smaller the changes are, the easier it is to fill out and justify the data collection.</p>
<p>But from my standpoint as a Mozilla employee, these data reviews are the primary way I see Mozilla making good on its promise to respect user privacy and avoid needless data collection. A lot of thought has gone into this process, and I can personally attest to their effectiveness.</p>
<div class="footnotes">
<hr>
<ol><li id="fn-1"><p>Firefox uses tons of automated testing, but we also have manual testing for certain features. In Shield's case, the time being wasted was in the manual phase.<a href="#fnref-1" rev="footnote">&#8617;</a></p></li>
<li id="fn-2"><p>Actually, we already do collect crashes as part of the <a href="http://socorro.readthedocs.io/en/latest/">Socorro</a> project, which I currently work on. But Socorro does not collect any info about the browser errors in question.<a href="#fnref-2" rev="footnote">&#8617;</a></p></li>
<li id="fn-3"><p>Only some parts of crash data are actually private, and certain contributors who sign an NDA are also allowed access to that private data. We use centralized authorization to control access.<a href="#fnref-3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

  </div>

  
    
  <div class="blog-post">
  
    <h2 class="blog-title"><a href="../blog/using-npm-libraries-in-firefox-via-webpack/">Using NPM Libraries in Firefox via Webpack</a></h2>
  
  <div class="meta">
    <span>
      <i class="octicon octicon-calendar"></i>
      July 11, 2017
    </span>
    <span>
      <i class="octicon octicon-tag"></i>
      mozilla
    </span>
  </div>
  <p>I work on a <a href="http://gecko.readthedocs.io/en/latest/toolkit/mozapps/extensions/addon-manager/SystemAddons.html">system add-on</a> for Firefox called the <a href="http://normandy.readthedocs.io/en/latest/dev/recipe-client-addon/index.html">Shield Recipe Client</a>. We develop it in a <a href="https://github.com/mozilla/normandy">monorepo on Github</a> along with the service it relies on and a few other libraries. One of these libraries is <a href="https://github.com/mozilla/normandy/tree/master/mozjexl">mozJexl</a>, an expression language that we use to specify how to filter experiments and surveys we send to users.</p>
<p>The system add-on relies on mozJexl, and for a while we were pulling in the dependency by copying it from <code>node_modules</code> and using a <a href="https://developer.mozilla.org/en-US/Add-ons/SDK/Low-Level_APIs/_loader">custom CommonJS loader</a> to make <code>require()</code> calls work properly. This wasn't ideal for a few reasons:</p>
<ul>
<li><p>We had to determine manually which file contained the exports we needed, instead of being able to use the documented exports that you'd get from a <code>require()</code> call.</p>
</li>
<li><p>Because library files could <code>require()</code> any other file within <code>node_modules</code> we copied the entire directory within our add-on.</p>
</li>
<li><p>We didn't hit this with mozJexl, but I'm pretty sure that if a library we wanted to include had dependencies of its own, our custom loader wouldn't have resolved the paths properly.</p>
</li>
</ul>
<p>While working on another patch, I hit a point where I wanted to pull in <a href="http://epoberezkin.github.io/ajv/">ajv</a> to do some schema validation and decided to see if I could come up with something better.</p>
<h2>Webpack</h2>
<p>I already knew that a few components within Firefox are using <a href="https://webpack.github.io/">Webpack</a>, such as <a href="https://devtools-html.github.io/debugger.html/">debugger.html</a> and <a href="https://testpilot.firefox.com/experiments/activity-stream">Activity Stream</a>. As far as I can tell, they bundle all of their code together, which is standard for Webpack.</p>
<p>I wanted to avoid this, because we sometimes get fixes from Firefox developers that we upstream back to Github. We also get help in the form of debugging from developers investigating issues that lead back to our add-on. Both of these would be made more difficult by landing webpacked code that is different from the source code we normally work on.</p>
<p>Instead, my goal was to webpack only the libraries that we want to use in a way that provided a similar experience to <code>require()</code>. Here's the Webpack configuration that I came up with:</p>
<div class="highlight"><pre><span></span><span class="cm">/* eslint-env node */</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ConcatSource</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;webpack-sources&quot;</span><span class="p">).</span><span class="nx">ConcatSource</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">LicenseWebpackPlugin</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;license-webpack-plugin&quot;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">context</span><span class="o">:</span> <span class="nx">__dirname</span><span class="p">,</span>
  <span class="nx">entry</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">mozjexl</span><span class="o">:</span> <span class="s2">&quot;./node_modules/mozjexl/&quot;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">output</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">path</span><span class="o">:</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s2">&quot;vendor/&quot;</span><span class="p">),</span>
    <span class="nx">filename</span><span class="o">:</span> <span class="s2">&quot;[name].js&quot;</span><span class="p">,</span>
    <span class="nx">library</span><span class="o">:</span> <span class="s2">&quot;[name]&quot;</span><span class="p">,</span>
    <span class="nx">libraryTarget</span><span class="o">:</span> <span class="s2">&quot;this&quot;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
    <span class="cm">/**</span>
<span class="cm">     * Plugin that appends &quot;this.EXPORTED_SYMBOLS = [&quot;libname&quot;]&quot; to assets</span>
<span class="cm">     * output by webpack. This allows built assets to be imported using</span>
<span class="cm">     * Cu.import.</span>
<span class="cm">     */</span>
    <span class="kd">function</span> <span class="nx">ExportedSymbols</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="s2">&quot;emit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">compilation</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">libraryName</span> <span class="k">in</span> <span class="nx">compilation</span><span class="p">.</span><span class="nx">entrypoints</span><span class="p">)</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="nx">assetName</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">libraryName</span><span class="si">}</span><span class="sb">.js`</span><span class="p">;</span> <span class="c1">// Matches output.filename</span>
          <span class="nx">compilation</span><span class="p">.</span><span class="nx">assets</span><span class="p">[</span><span class="nx">assetName</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ConcatSource</span><span class="p">(</span>
            <span class="s2">&quot;/* eslint-disable */&quot;</span><span class="p">,</span> <span class="c1">// Disable linting</span>
            <span class="nx">compilation</span><span class="p">.</span><span class="nx">assets</span><span class="p">[</span><span class="nx">assetName</span><span class="p">],</span>
            <span class="sb">`this.EXPORTED_SYMBOLS = [&quot;</span><span class="si">${</span><span class="nx">libraryName</span><span class="si">}</span><span class="sb">&quot;];`</span> <span class="c1">// Matches output.library</span>
          <span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">callback</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">},</span>
    <span class="k">new</span> <span class="nx">LicenseWebpackPlugin</span><span class="p">({</span>
      <span class="nx">pattern</span><span class="o">:</span> <span class="sr">/^(MIT|ISC|MPL.*|Apache.*|BSD.*)$/</span><span class="p">,</span>
      <span class="nx">filename</span><span class="o">:</span> <span class="sb">`LICENSE_THIRDPARTY`</span><span class="p">,</span>
    <span class="p">}),</span>
  <span class="p">],</span>
<span class="p">};</span>
</pre></div>
<p>(See also <a href="https://github.com/mozilla/normandy/pull/877">the pull request itself</a>.)</p>
<p>Each entry point in the config is a library that we want to use, with the key being the name we're using to export it, and the value being the path to its directory in <code>node_modules</code><sup class="footnote-ref" id="fnref-1"><a href="#fn-1" rel="footnote">1</a></sup>. The output of this config is one file per entry point inside a <code>vendor</code> subdirectory. You can then import these files as if they were normal <code>.jsm</code> files:</p>
<div class="highlight"><pre><span></span><span class="nx">Cu</span><span class="p">.</span><span class="kr">import</span><span class="p">(</span><span class="s2">&quot;resource://shield-recipe-client/vendor/mozjexl.js&quot;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">jexl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">moxjexl</span><span class="p">.</span><span class="nx">Jexl</span><span class="p">();</span>
</pre></div>
<h2>output.library</h2>
<p>The key turned out to be Webpack's options for bundling libraries:</p>
<ul>
<li><a href="https://webpack.js.org/configuration/output/#output-library"><code>output.library</code></a>: Name of the library you want to export.</li>
<li><a href="https://webpack.js.org/configuration/output/#output-librarytarget"><code>output.libraryTarget</code></a>: How you want to expose your library.</li>
</ul>
<p>By setting <code>output.library</code> to a name like <code>mozJexl</code>, and <code>output.libraryTarget</code> to <code>this</code>, you can produce a bundle that assigns the exports from your entry point to <code>this.mozJexl</code>. In the configuration above, I use the webpack variable <code>[name]</code> to set it to the name for each export, since we're exporting multiple libraries with one config.</p>
<h2>ExportedSymbols</h2>
<p>Assuming that the bundle will work in a chrome environment, this is very close to being a <a href="https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/Using">JavaScript code module</a>. The only thing missing is <code>this.EXPORTED_SYMBOLS</code> to define what names we're exporting. Luckily, we already know the name of the symbols being exported, and we know the filename that will be used for each entry point.</p>
<p>I used this info to write a small Webpack plugin that prepends an <a href="http://eslint.org/">eslint</a>-ignore comment to the start of each generated file (since we don't want to lint bundled code) and <code>this.EXPORTED_SYMBOLS</code> to the end of each generated file:</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">ExportedSymbols</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="s2">&quot;emit&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">compilation</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">libraryName</span> <span class="k">in</span> <span class="nx">compilation</span><span class="p">.</span><span class="nx">entrypoints</span><span class="p">)</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">assetName</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">libraryName</span><span class="si">}</span><span class="sb">.js`</span><span class="p">;</span> <span class="c1">// Matches output.filename</span>
      <span class="nx">compilation</span><span class="p">.</span><span class="nx">assets</span><span class="p">[</span><span class="nx">assetName</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ConcatSource</span><span class="p">(</span>
        <span class="s2">&quot;/* eslint-disable */&quot;</span><span class="p">,</span> <span class="c1">// Disable linting</span>
        <span class="nx">compilation</span><span class="p">.</span><span class="nx">assets</span><span class="p">[</span><span class="nx">assetName</span><span class="p">],</span>
        <span class="sb">`this.EXPORTED_SYMBOLS = [&quot;</span><span class="si">${</span><span class="nx">libraryName</span><span class="si">}</span><span class="sb">&quot;];`</span> <span class="c1">// Matches output.library</span>
      <span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<h2>Licenses</h2>
<p>During code review, <a href="http://www.mythmon.com/">mythmon</a> brought up an excellent question; how do we retain licensing info for these files when we sync to mozilla-central? Turns out, there's a rather popular Webpack plugin called <a href="https://www.npmjs.com/package/license-webpack-plugin">license-webpack-plugin</a> that collects license files found during a build and outputs them into a single file:</p>
<div class="highlight"><pre><span></span><span class="k">new</span> <span class="nx">LicenseWebpackPlugin</span><span class="p">({</span>
  <span class="nx">pattern</span><span class="o">:</span> <span class="sr">/^(MIT|ISC|MPL.*|Apache.*|BSD.*)$/</span><span class="p">,</span>
  <span class="nx">filename</span><span class="o">:</span> <span class="sb">`LICENSE_THIRDPARTY`</span><span class="p">,</span>
<span class="p">}),</span>
</pre></div>
<p>(Why MIT/ISC/MPL/etc.? I just used what I thought were common licenses for libraries we were likely to use.)</p>
<h2>Future Improvements</h2>
<p>This is already a useful improvement over our old method of pulling in dependencies, but there are some potential improvements I'd eventually like to get to:</p>
<ul>
<li><p>The file size of third-party libraries is not insignificant, especially with their own dependencies. I'd like to consider minifying the bundles, potentially with source maps to aid debugging. I'm not even sure that's a thing for chrome code, though.</p>
</li>
<li><p>Some libraries may rely on browser globals, like <code>fetch</code>. I'd like to figure out how to auto-prepend <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Language_Bindings/Components.utils.importGlobalProperties">Components.utils.importGlobalProperties</a> to library files that need certain globals that aren't normally available.</p>
</li>
<li><p>If several system add-ons use this pattern, we might end up with multiple copies of the same library in mozilla-central. Deduplicating this code where possible would be nice.</p>
</li>
<li><p>If there's enough interest in it, I'd be interested in pulling this pattern out into some sort of plugin/preset so that other system add-ons can also use npm libraries with ease.</p>
</li>
</ul>
<div class="footnotes">
<hr>
<ol><li id="fn-1"><p>Did you know that Webpack will automatically use the main module defined in <code>package.json</code> as the entry point if the path points to a directory with that file?<a href="#fnref-1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

  </div>

  
    
  <div class="blog-post">
  
    <h2 class="blog-title"><a href="../blog/q-is-scary/">Q is Scary</a></h2>
  
  <div class="meta">
    <span>
      <i class="octicon octicon-calendar"></i>
      June 8, 2017
    </span>
    <span>
      <i class="octicon octicon-tag"></i>
      mozilla
    </span>
  </div>
  <p><a href="https://github.com/zestyping/q">q</a> is the hands-down winner of my "Libraries I'm Terrified Of" award. It's a Python library for outputting debugging information while running a program.</p>
<p>On the surface, everything seems fine. It logs everything to <code>/tmp/q</code> (configurable), which you can watch with <code>tail -f</code>. The basic form of q is passing it a variable:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">q</span>

<span class="n">foo</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">q</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</pre></div>
<p>Take a good long look at that code sample, and then answer me this: What is the type of q?</p>
<p>If you said "callable module", you are right. Also, that is not a thing that exists in Python.</p>
<p>Also, check out the output in <code>/tmp/q</code>:</p>
<pre><code>0.0s &lt;module&gt;: foo=7
</code></pre>
<p><em>It knows the variable name.</em> It also knows that it's being called at the module level; if we were in a function, <code>&lt;module&gt;</code> would be replaced with the name of the function.</p>
<p>You can also divide (<code>/</code>) or bitwise OR (<code>|</code>) values with q to log them as well. And you can decorate a function with it to trace the arguments and return value. It also has a method, <code>q.d()</code>, that starts an interactive session.</p>
<p>And it does all this in under 400 lines, the majority of which is either a docstring or code to format the output.</p>
<figure>
    <img alt="Spooky" src="/blog/q-is-scary/napstablook.gif">
    <figcaption>Spooky.</figcaption>
</figure><h2>How in the Hell</h2>
<p>So first, let's get this callable module stuff out of the way. Here's the last two lines in <code>q.py</code>:</p>
<div class="highlight"><pre><span></span><span class="c1"># Install the Q() object in sys.modules so that &quot;import q&quot; gives a callable q.</span>
<span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span><span class="p">()</span>
</pre></div>
<p>Turns out <code>sys.modules</code> is a dictionary with all the loaded modules, and you can just stuff it with whatever nonsense you like.</p>
<p>The <code>Q</code> class itself is super-fun. Check out the declaration:</p>
<div class="highlight"><pre><span></span><span class="c1"># When we insert Q() into sys.modules, all the globals become None, so we</span>
<span class="c1"># have to keep everything we use inside the Q class.</span>
<span class="k">class</span> <span class="nc">Q</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="vm">__doc__</span>  <span class="c1"># from the module&#39;s __doc__ above</span>

    <span class="kn">import</span> <span class="nn">ast</span>
    <span class="kn">import</span> <span class="nn">code</span>
    <span class="kn">import</span> <span class="nn">inspect</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">pydoc</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">random</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">import</span> <span class="nn">functools</span>
</pre></div>
<p><strong>"When we insert Q() into sys.modules, all the globals become None"</strong></p>
<p>What? Why?! I mean I can see how that's not an issue for modules, which are usually the only things inside <code>sys.modules</code>, but still. I tried chasing this down, but the entire <code>sys</code> module is <a href="https://github.com/python/cpython/blob/48fb766f70d9ca9d5934cbddbe8d8e7972cb6343/Python/sysmodule.c">written in C</a>, and that ain't my business.</p>
<p>Most of the other bits inside <code>Q</code> are straightforward by comparison; a few helpers for outputting stuff cleanly, overrides for <code>__truediv__</code> and <code>__or__</code> for those weird operator versions of logging, etc. If you've never heard of callable types<sup class="footnote-ref" id="fnref-1"><a href="#fn-1" rel="footnote">1</a></sup> before, that's the reason why an instance of this class can be both called as a function and treated as a value.</p>
<p>So what's <code>__call__</code> do?</p>
<h2>Ghost Magic</h2>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If invoked as a decorator on a function, adds tracing output to the</span>
<span class="sd">    function; otherwise immediately prints out the arguments.&quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">context</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>

    <span class="c1"># ... snip ...</span>
</pre></div>
<p>Welcome to the <a href="https://docs.python.org/3/library/inspect.html">inspect module</a>. Turns out, Python has a built-in module that lets you get all sorts of fun info about objects, classes, etc. It also lets you get info about <strong>stack frames</strong>, which store the state of each subroutine in the chain of subroutine calls that led to running the code that's currently executing.</p>
<p>Here, q is using a CPython-specific function <code>sys._getframe</code> to get a frame object for the code that called q, and then using inspect to get info about that code.</p>
<div class="highlight"><pre><span></span><span class="c1"># info.index is the index of the line containing the end of the call</span>
<span class="c1"># expression, so this gets a few lines up to the end of the expression.</span>
<span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">code_context</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">code_context</span><span class="p">[:</span><span class="n">info</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># If we see &quot;@q&quot; on a single line, behave like a trace decorator.</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;@q&#39;</span><span class="p">,</span> <span class="s1">&#39;@q()&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
<p>...and then it just does a text search of the source code to figure out if it was called as a function or as a decorator. Because it can't just guess by the type of the argument being passed (you might want to log a function object), and it can't just return a callable that can be used as a decorator either.</p>
<p><code>trace</code> is pretty normal, whatever that means. It just logs the intercepted arguments and return value / raised exception.</p>
<div class="highlight"><pre><span></span><span class="c1"># Otherwise, search for the beginning of the call expression; once it</span>
<span class="c1"># parses, use the expressions in the call to label the debugging</span>
<span class="c1"># output.</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_call_exprs</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">:])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
        <span class="k">break</span>
<span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<span class="k">return</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
<p>The last bit pulls out labels from the source code; this is how q knows the name of the variable that you pass in. I'm not going to go line-by-line through <code>get_call_exprs</code>, but it uses the <a href="https://docs.python.org/3/library/ast.html">ast</a> module to parse the function call into an Abstract Syntax Tree, and walks through that to find the variable names.</p>
<hr>
<p>It goes without saying that you should never do any of this. Ever. Nothing is sacred when it comes to debugging, though, and q is incredibly useful when you're having trouble getting your program to print anything out sanely.</p>
<p>Also, if you're ever bored on a nice summer evening, check out the <a href="https://docs.python.org/3/library/index.html">list of modules in the Python standard library</a>. It's got <em>everything</em>:</p>
<ul>
<li><a href="https://docs.python.org/3/library/tracemalloc.html">Tracing memory allocations</a></li>
<li><a href="https://docs.python.org/3/library/gc.html">Controlling the garbage collector</a></li>
<li><a href="https://docs.python.org/3/library/tabnanny.html">Linting python files for ambiguous indentation</a></li>
<li><a href="https://docs.python.org/3/library/difflib.html">Computing diffs</a></li>
<li><a href="https://docs.python.org/3/library/weakref.html">Weakrefs</a></li>
<li><a href="https://docs.python.org/3/library/atexit.html">Running code when your program exits</a></li>
<li><a href="https://docs.python.org/3/library/wave.html">Manipulating wave audio files</a></li>
</ul>
<div class="footnotes">
<hr>
<ol><li id="fn-1"><p><a href="https://docs.python.org/3/reference/datamodel.html">Check out this page</a> and search for "Callable Types" and/or <code>__call__</code>.<a href="#fnref-1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

  </div>

  
    
  <div class="blog-post">
  
    <h2 class="blog-title"><a href="../blog/build-and-sign-webextensions-with-circleci/">Build and Sign WebExtensions with CircleCI</a></h2>
  
  <div class="meta">
    <span>
      <i class="octicon octicon-calendar"></i>
      May 4, 2017
    </span>
    <span>
      <i class="octicon octicon-tag"></i>
      mozilla
    </span>
  </div>
  <p>Once <a href="https://planet.mozilla.org/">Planet Mozilla</a> updated with my <a href="../blog/mailman-admin-helper-mildly-easier-mailman-spam-management/">last post</a>, I got a few bug reports and feature requests for <a href="https://github.com/Osmose/mailman-admin-helper">mailman-admin-helper</a>, along with a pull request (Thanks, <a href="https://github.com/wagnerand">TheOne</a>!). Clearly I'm not the only person who isn't a fan of our mailing list admin.</p>
<p>Before landing anything, I decided to see if I could get automatic builds running so that I wouldn't have to pull a build pull requests myself when I want to test them. What I ended up with, however, does a bit more than that; it also runs lints, and even signs and uploads new releases when I push a new tag.</p>
<p>We use <a href="https://github.com/mozilla/normandy">CircleCI</a> on <a href="https://github.com/mozilla/normandy">Normandy</a>, so I defaulted to using them for this as well. I'll walk through the sections, but here's the entire <code>circle.yml</code> file I ended up with:</p>
<div class="highlight"><pre><span></span><span class="nt">machine</span><span class="p">:</span>
  <span class="nt">node</span><span class="p">:</span>
    <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">7.10.0</span>
<span class="nt">dependencies</span><span class="p">:</span>
  <span class="nt">override</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo apt-get update; sudo apt-get install jq</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">go get -u github.com/tcnksm/ghr</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">npm install -g web-ext</span>
<span class="nt">compile</span><span class="p">:</span>
  <span class="nt">override</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web-ext build</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mv web-ext-artifacts $CIRCLE_ARTIFACTS</span>
<span class="nt">test</span><span class="p">:</span>
  <span class="nt">override</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web-ext lint --self-hosted</span>
<span class="nt">deployment</span><span class="p">:</span>
  <span class="nt">release</span><span class="p">:</span>
    <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/v[0-9]+(\.[0-9]+)*/</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Osmose</span>
    <span class="nt">commands</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jq --arg tag &quot;${CIRCLE_TAG:1}&quot; &#39;.version = $tag&#39; manifest.json &gt; tmp.json &amp;&amp; mv tmp.json manifest.json</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web-ext sign --api-key $AMO_API_KEY --api-secret $AMO_API_SECRET</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ghr -u Osmose $CIRCLE_TAG web-ext-artifacts</span>
</pre></div>
<p>If you want to adapt this to your own project, you'll want to change the <code>deployment.release.owner</code> field to the Github account hosting your WebExtension, and add the following environment variables to your CircleCI project config (<strong>NOT</strong> your <code>circle.yml</code> file, which is committed to your repo):</p>
<ul>
<li><p><code>GITHUB_TOKEN</code>: A <a href="https://github.com/settings/tokens">personal access token</a> with either the <code>public_repo</code> or <code>repo</code> permissions, depending on whether your repository is public or private.</p>
</li>
<li><p><code>AMO_API_KEY</code>: The JWT issuer field from your <a href="https://addons.mozilla.org/en-US/developers/addon/api/key/">addons.mozilla.org API Credentials</a>.</p>
</li>
<li><p><code>AMO_API_SECRET</code>: The JWT secret field from your addons.mozilla.org API Credentials.</p>
</li>
</ul>
<h3>How does it work?</h3>
<p><a href="https://circleci.com/docs/1.0/configuration/">circle.yml</a> files are split into phases. Each phase has a default action that is overridden with the <code>override</code> key.</p>
<div class="highlight"><pre><span></span><span class="nt">machine</span><span class="p">:</span>
  <span class="nt">node</span><span class="p">:</span>
    <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">7.10.0</span>
</pre></div>
<p>The <code>machine</code> phase defines the machine used to run your build. Here we're just making sure that we have a recent version of Node.</p>
<div class="highlight"><pre><span></span><span class="nt">dependencies</span><span class="p">:</span>
  <span class="nt">override</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sudo apt-get update; sudo apt-get install jq</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">go get -u github.com/tcnksm/ghr</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">npm install -g web-ext</span>
</pre></div>
<p>The <code>dependencies</code> step is for installing libraries and programs that your build needs. Our build process has three dependencies:</p>
<ul>
<li><p><a href="https://stedolan.github.io/jq/">jq</a>: A command-line JSON processor that we use to replace the version number in <code>manifest.json</code>.</p>
</li>
<li><p><a href="https://github.com/tcnksm/ghr">ghr</a>: A tool for uploading artifacts to Github release pages. Our build image already has a recent version of Go installed, so we install this via [go get][].</p>
</li>
<li><p><a href="https://github.com/mozilla/web-ext">web-ext</a>: Mozilla's command-line tool for building and testing WebExtensions.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="nt">compile</span><span class="p">:</span>
  <span class="nt">override</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web-ext build</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">mv web-ext-artifacts $CIRCLE_ARTIFACTS</span>
</pre></div>
<p>The <code>compile</code> step is used to build your project before testing. While we aren't running any tests that need a built add-on, this is a good time to build the add-on and upload it to the <code>$CIRCLE_ARTIFACTS</code> directory, which is saved and made available for download once the build is complete. This makes it easy to pull a ready-to-test build of the add-on from open pull requests.</p>
<div class="highlight"><pre><span></span><span class="nt">test</span><span class="p">:</span>
  <span class="nt">override</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web-ext lint --self-hosted</span>
</pre></div>
<p>The <code>test</code> step is for actually running your tests. We don't have automated tests for mailman-admin-helper, but web-ext comes with a handy lint command to help catch common errors.</p>
<p>One thing to note about CircleCI is that any commands that return non-zero return codes will stop the build immediately and mark it as failed, <em>except</em> for commands in the <code>test</code> step. <code>test</code> step commands will mark a build as failed, but will not stop other commands in the <code>test</code> step from running. This is useful for running multiple types of tests or lints because it allows you to see all of your failures instead of exiting early before running all of your tests.</p>
<div class="highlight"><pre><span></span><span class="nt">deployment</span><span class="p">:</span>
  <span class="nt">release</span><span class="p">:</span>
    <span class="nt">tag</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/v[0-9]+(\.[0-9]+)*/</span>
    <span class="nt">owner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Osmose</span>
    <span class="nt">commands</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jq --arg tag &quot;${CIRCLE_TAG:1}&quot; &#39;.version = $tag&#39; manifest.json &gt; tmp.json &amp;&amp; mv tmp.json manifest.json</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">web-ext sign --api-key $AMO_API_KEY --api-secret $AMO_API_SECRET</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ghr -u Osmose $CIRCLE_TAG web-ext-artifacts</span>
</pre></div>
<p>The <code>deployment</code> section only runs on successful builds, and handles deploying your code. It's made up of multiple named sections, and each section must either have a <code>branch</code> or <code>tag</code> field describing the branches or tags that the section will run for.</p>
<p>In our case, we're using a regex that matches tags named like version numbers prefixed with <code>v</code>, e.g. <code>v0.1.2</code>. We also set the <code>owner</code> to my Github account so that forks will not run the deployment process.</p>
<p>The commands do three things:</p>
<ol>
<li><p>Use <code>jq</code> to modify the <code>version</code> key in <code>manifest.json</code> to match the version number from the tag. The <code>v</code> prefix is removed before the replacement.</p>
</li>
<li><p>Use <code>web-ext</code> to build and sign the WebExtension, using API keys stored in environment variables. This creates an XPI file in the <code>web-ext-artifacts</code> directory.</p>
</li>
<li><p>Use <code>ghr</code> to upload the contents of <code>web-ext-artifacts</code> (which should just by the signed XPI) to the tag on Github. This uses the <code>GITHUB_TOKEN</code> environment variable for authentication.</p>
</li>
</ol>
<p>The end result is that, whenever a new tag is pushed to the repository, CircleCI adds a signed XPI to the release page on Github automatically, without any human intervention. Convenient!</p>
<hr>
<p>Feel free to steal this for your own WebExtension, or share any comments or suggestions either in the comments or directly on the mailman-admin-helper repository. Thanks for reading!</p>

  </div>

  
    
  <div class="blog-post">
  
    <h2 class="blog-title"><a href="../blog/mailman-admin-helper-mildly-easier-mailman-spam-management/">mailman-admin-helper: Mildly Easier Mailman Spam Management</a></h2>
  
  <div class="meta">
    <span>
      <i class="octicon octicon-calendar"></i>
      April 30, 2017
    </span>
    <span>
      <i class="octicon octicon-tag"></i>
      mozilla
    </span>
  </div>
  <p>Mozilla hosts a few <a href="http://www.list.org/">Mailman</a> instances<sup class="footnote-ref" id="fnref-1"><a href="#fn-1" rel="footnote">1</a></sup>, and I run a few mailing lists on them. Our interface for managing incoming spam is... okay.</p>
<p><a href="../blog/mailman-admin-helper-mildly-easier-mailman-spam-management/mailman_before.png"><img alt="Mailman default admindb interface" src="/blog/mailman-admin-helper-mildly-easier-mailman-spam-management/mailman_before.png"></a></p>
<p>The form inputs are <em>tiny</em>. And it takes, like, 3 clicks to discard and blacklist spam per-sender. And, because I only learned about the options for filtering by spam headers within the past month, I had to use this interface on a daily basis for years.</p>
<p>Finally, about a year or so ago, I got fed up and wrote a bookmarklet that auto-clicked every form element needed to discard and blacklist every email on the page. Since it's rare for the lists I moderate to get legitimate emails that are marked for moderation, I didn't need anything more complex.</p>
<p>However, we recently updated our Mailman pages to use <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy">CSP</a>, specifically the <code>script-src none</code> directive. Because the pages no longer accept <em>any</em> URL as valid for script execution, my bookmarklet stopped working. I searched online for workarounds and didn't find anything informative<sup class="footnote-ref" id="fnref-2"><a href="#fn-2" rel="footnote">2</a></sup>.</p>
<p>Luckily, I happen to have experience making <a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions">WebExtensions</a> that inject <a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Content_scripts">content scripts</a> into web pages. It's as simple as creating a <code>manifest.json</code> file:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;manifest_version&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mailman-admin-helper&quot;</span><span class="p">,</span>
  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;0.1.1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;applications&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;gecko&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;mailman-admin-helper@mkelly.me&quot;</span>
    <span class="p">}</span>
  <span class="p">},</span>

  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Adds useful shortcuts to Mozilla Mailman admin.&quot;</span><span class="p">,</span>

  <span class="nt">&quot;content_scripts&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;matches&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;*://mail.mozilla.org/admindb/*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;*://lists.mozilla.org/admindb/*&quot;</span>
      <span class="p">],</span>
      <span class="nt">&quot;js&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;index.js&quot;</span><span class="p">],</span>
      <span class="nt">&quot;css&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;index.css&quot;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>The <code>content_scripts</code> key is where the magic happens. List some domains, write some JavaScript and CSS, and you're done! The <a href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Getting_started_with_web-ext">web-ext</a> tool makes testing, building, and signing the extension pretty painless.</p>
<p>An hour or two later, and I had finished my new WebExtension, <a href="https://github.com/Osmose/mailman-admin-helper">mailman-admin-helper</a>. After it is installed, the admin interface is greatly simplified:</p>
<p><a href="../blog/mailman-admin-helper-mildly-easier-mailman-spam-management/mailman_after.png"><img alt="Mailman admindb interface as modified by the mailman-admin-helper extension" src="/blog/mailman-admin-helper-mildly-easier-mailman-spam-management/mailman_after.png"></a></p>
<p>The block of checkboxes and radio buttons has been replaced by 4 buttons that immediately make their changes and refresh the page when clicked. And if you need to inspect and modify an individual email, you can still click through the email subject to get to the normal moderation page.</p>
<p>Granted, it cuts out a lot of functionality, but this extension is mostly meant for myself to use. Pull requests are welcome, though, in case anyone wants to add functionality that they commonly use.</p>
<p>Big thanks to the Add-ons team and community for making WebExtensions super-easy to use!</p>
<div class="footnotes">
<hr>
<ol><li id="fn-1"><p>I'm not entirely sure why we have two, but it's cool.<a href="#fnref-1" rev="footnote">&#8617;</a></p></li>
<li id="fn-2"><p>I did find <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=866522">bug 866522</a>, which discusses the reason bookmarklets don't work with CSP, as well as some proposed fixes to Firefox and the (in my opinion, correct) wisdom that bookmarklets are a dead-end anyway.<a href="#fnref-2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

  </div>

  
    
  <div class="blog-post">
  
    <h2 class="blog-title"><a href="../blog/content-uitourjs/">content-UITour.js</a></h2>
  
  <div class="meta">
    <span>
      <i class="octicon octicon-calendar"></i>
      April 25, 2017
    </span>
    <span>
      <i class="octicon octicon-tag"></i>
      mozilla
    </span>
  </div>
  <p>Recently I found myself trying to comprehend an unfamiliar piece of code. In this case, it was <a href="https://dxr.mozilla.org/mozilla-central/source/browser/components/uitour/content-UITour.js"><code>content-UITour.js</code></a>, a file that handles the interaction between unprivileged webpages and <a href="https://dxr.mozilla.org/mozilla-central/source/browser/components/uitour/UITour.jsm"><code>UITour.jsm</code></a>.</p>
<p><a href="http://bedrock.readthedocs.io/en/latest/uitour.html">UITour</a> allows webpages to highlight buttons in the toolbar, open menu panels, and perform other tasks involved in giving Firefox users a tour of the user interface. The event-based API allows us to iterate quickly on the onboarding experience for Firefox by controlling it via easily-updated webpages. Only a small set of Mozilla-owned domains are allowed access to the UITour API.</p>
<h3>Top-level View</h3>
<p>My first step when trying to grok unfamiliar JavaScript is to check out everything at the top-level of the file. If we take <code>content-UITour.js</code> and remove some comments, imports, and constants, we get:</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">UITourListener</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">handleEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* ... */</span>
  <span class="p">},</span>

  <span class="cm">/* ... */</span>
<span class="p">};</span>

<span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;mozUITour&quot;</span><span class="p">,</span> <span class="nx">UITourListener</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</pre></div>
<p>Webpages that want to use UITour emit <a href="https://developer.mozilla.org/en-US/docs/Web/Guide/Events/Creating_and_triggering_events">synthetic events</a> with the name <code>"mozUITour"</code>. In the snippet above, <code>UITourListener</code> is the object that receives these events. Normally, event listeners are functions, but they can also be <a href="https://developer.mozilla.org/en-US/docs/Web/API/EventListener">EventListeners</a>, which are simply objects with a <code>handleEvent</code> function.</p>
<p>According to <a href="https://github.com/mozilla/normandy/issues/416#issuecomment-294193031">Mossop's comment</a>, <code>content-UITour.js</code> is <a href="https://dxr.mozilla.org/mozilla-central/source/browser/base/content/browser.js#1159">loaded in <code>browser.js</code></a>. A search for <code>firefox loadFrameScript</code> brings up two useful pages:</p>
<ul>
<li><p><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Reference/Interface/nsIFrameScriptLoader">nsIFrameScriptLoader</a>, which describes how <code>loadFrameScript</code> takes our JavaScript file and loads it into a remote frame. If you don't innately know what a remote frame is, then you should read...</p>
</li>
<li><p><a href="https://developer.mozilla.org/en-US/Firefox/Multiprocess_Firefox/Message_Manager/Message_manager_overview">Message manager overview</a>, which gives a great overview of frame scripts and how they relate to multi-process Firefox. In particular, <code>browser.js</code> seems to be asking for a <a href="https://developer.mozilla.org/en-US/Firefox/Multiprocess_Firefox/Message_Manager/Message_manager_overview#Browser_message_manager">browser message manager</a>.</p>
</li>
</ul>
<p>It looks like <code>content-UITour.js</code> is loaded for each tab with a webpage open, but it can do some more privileged stuff than a normal webpage. Also, the global object seems to be <code>window</code>, referring to the browser window containing the webpage, since events from the webpage are bubbling up to it. Neat!</p>
<h3>Events from Webpages</h3>
<p>So what about <code>handleEvent</code>?</p>
<div class="highlight"><pre><span></span><span class="nx">handleEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Services</span><span class="p">.</span><span class="nx">prefs</span><span class="p">.</span><span class="nx">getBoolPref</span><span class="p">(</span><span class="s2">&quot;browser.uitour.enabled&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ensureTrustedOrigin</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">addMessageListener</span><span class="p">(</span><span class="s2">&quot;UITour:SendPageCallback&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="nx">addMessageListener</span><span class="p">(</span><span class="s2">&quot;UITour:SendPageNotification&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="nx">sendAsyncMessage</span><span class="p">(</span><span class="s2">&quot;UITour:onPageEvent&quot;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">detail</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">detail</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
    <span class="nx">pageVisibilityState</span><span class="o">:</span> <span class="nx">content</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">visibilityState</span><span class="p">,</span>
  <span class="p">});</span>
<span class="p">},</span>
</pre></div>
<p>If UITour itself is disabled, or if the origin of the webpage we're registered on isn't trustworthy, events are thrown away. Otherwise, we register <code>UITourListener</code> as a message listener, and send a message of our own.</p>
<p>I remember seeing <code>addMessageListener</code> and <code>sendAsyncMessage</code> on the browser message manager documentation; they look like a fairly standard event system. But where are these events coming from, and where are they going to?</p>
<p>In lieu of any better leads, our best bet is to search DXR for <code>"UITour:onPageEvent"</code>, which leads to <a href="https://dxr.mozilla.org/mozilla-central/source/browser/components/nsBrowserGlue.js#2655"><code>nsBrowserGlue.js</code></a>. Luckily for us, I've actually heard of this file before: it's a grab-bag for things that need to happen to set up Firefox that don't fit anywhere else. For our purposes, it's enough to know that stuff in here gets run once when the browser starts.</p>
<p>The lines in question:</p>
<div class="highlight"><pre><span></span><span class="c1">// Listen for UITour messages.</span>
<span class="c1">// Do it here instead of the UITour module itself so that the UITour module is lazy loaded</span>
<span class="c1">// when the first message is received.</span>
<span class="kd">var</span> <span class="nx">globalMM</span> <span class="o">=</span> <span class="nx">Cc</span><span class="p">[</span><span class="s2">&quot;@mozilla.org/globalmessagemanager;1&quot;</span><span class="p">].</span><span class="nx">getService</span><span class="p">(</span><span class="nx">Ci</span><span class="p">.</span><span class="nx">nsIMessageListenerManager</span><span class="p">);</span>
<span class="nx">globalMM</span><span class="p">.</span><span class="nx">addMessageListener</span><span class="p">(</span><span class="s2">&quot;UITour:onPageEvent&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">aMessage</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">UITour</span><span class="p">.</span><span class="nx">onPageEvent</span><span class="p">(</span><span class="nx">aMessage</span><span class="p">,</span> <span class="nx">aMessage</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
<p>Oh, I remember reading about the <a href="https://developer.mozilla.org/en-US/Firefox/Multiprocess_Firefox/Message_Manager/Message_manager_overview#Global_frame_message_manager">global message manager</a>! It covers <em>every</em> frame. This seems to be where all the events coming up from individual frames get gathered and passed to UITour. That <code>UITour</code> variable is coming from a clever lazy-import block at the top:</p>
<div class="highlight"><pre><span></span><span class="p">[</span>
<span class="cm">/* ... */</span>
<span class="p">[</span><span class="s2">&quot;UITour&quot;</span><span class="p">,</span> <span class="s2">&quot;resource:///modules/UITour.jsm&quot;</span><span class="p">],</span>
<span class="cm">/* ... */</span>
<span class="p">].</span><span class="nx">forEach</span><span class="p">(([</span><span class="nx">name</span><span class="p">,</span> <span class="nx">resource</span><span class="p">])</span> <span class="p">=&gt;</span> <span class="nx">XPCOMUtils</span><span class="p">.</span><span class="nx">defineLazyModuleGetter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">resource</span><span class="p">));</span>
</pre></div>
<p>In other words, <code>UITour</code> refers to the module in <code>UITour.jsm</code>, but it isn't loaded until we receive our first event, which helps make Firefox startup snappier.</p>
<p>For our purposes, we're not terribly interested in what UITour does with these messages, as long as we know how they're getting there. We are, however, interested in the messages that we're listening for: <code>"UITour:SendPageCallback"</code> and <code>"UITour:SendPageNotification"</code>. Another DXR search tells me that those are in <a href="https://dxr.mozilla.org/mozilla-central/source/browser/components/uitour/UITour.jsm#897"><code>UITour.jsm</code></a>. A skim of the results shows that these messages are used for things like notifying the webpage when an operation is finished, or returning information that was requested by the webpage.</p>
<hr>
<p>To summarize:</p>
<ul>
<li><p><code>handleEvent</code> in the content process triggers behavior from <code>UITour.jsm</code> in the chrome process by sending and receiving messages sent through the message manager system.</p>
</li>
<li><p><code>handleEvent</code> checks that the origin of a webpage is trustworthy before doing anything.</p>
</li>
<li><p>The UITour module in the chrome process is not initialized until a webpage emits an event for it.</p>
</li>
</ul>
<p>The rest of the <code>content-UITour.js</code> is split between origin verification and sending events back down to the webpage.</p>
<h3>Verifying Webpage URLs</h3>
<p>Next, let's take a look at <code>ensureTrustedOrigin</code>:</p>
<div class="highlight"><pre><span></span><span class="nx">ensureTrustedOrigin</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">top</span> <span class="o">!=</span> <span class="nx">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="kd">let</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentURIObject</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">schemeIs</span><span class="p">(</span><span class="s2">&quot;chrome&quot;</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isSafeScheme</span><span class="p">(</span><span class="nx">uri</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="kd">let</span> <span class="nx">permission</span> <span class="o">=</span> <span class="nx">Services</span><span class="p">.</span><span class="nx">perms</span><span class="p">.</span><span class="nx">testPermission</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span> <span class="nx">UITOUR_PERMISSION</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">permission</span> <span class="o">==</span> <span class="nx">Services</span><span class="p">.</span><span class="nx">perms</span><span class="p">.</span><span class="nx">ALLOW_ACTION</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">isTestingOrigin</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span>
<span class="p">},</span>
</pre></div>
<p>MDN tells us that <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/content"><code>content</code></a> is the Window object for the primary content window; in other words, the webpage. <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/top"><code>top</code></a>, on the other hand, is the topmost window in the window hierarchy (relevant for webpages that get loaded in iframes). Thus, the first check is to make sure we're not in some sort of frame. Without this, a webpage could control when UITour executes things by loading a whitelisted origin in an iframe<sup class="footnote-ref" id="fnref-1"><a href="#fn-1" rel="footnote">1</a></sup>.</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/top">documentURIObject</a> lets us check the origin of the loaded webpage. <code>chrome://</code> URIs get passed immediately, since they're already privileged. The next three checks are more interesting:</p>
<h4>isSafeScheme</h4>
<div class="highlight"><pre><span></span><span class="nx">isSafeScheme</span><span class="p">(</span><span class="nx">aURI</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">allowedSchemes</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">([</span><span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;about&quot;</span><span class="p">]);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Services</span><span class="p">.</span><span class="nx">prefs</span><span class="p">.</span><span class="nx">getBoolPref</span><span class="p">(</span><span class="s2">&quot;browser.uitour.requireSecure&quot;</span><span class="p">))</span>
    <span class="nx">allowedSchemes</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">allowedSchemes</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">aURI</span><span class="p">.</span><span class="nx">scheme</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">},</span>
</pre></div>
<p>This function checks the URI scheme to see if it's considered "safe" enough to use UITour functions. By default, <code>https://</code> and <code>about:</code> pages are allowed. <code>http://</code> pages are also allowed if the <code>browser.uitour.requireSecure</code> preference is false (it defaults to true).</p>
<h4>Permissions</h4>
<p>The next check is against the permissions system. The <a href="https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/Services.jsm"><code>Services.jsm</code></a> documentation says that <code>Services.perms</code> refers to an instance of the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Reference/Interface/nsIPermissionManager">nsIPermissionManager</a> interface. The check itself is easy to understand, but what's missing is how these permissions get added in the first place. A fresh Firefox profile has some sites already whitelisted for UITour, but where does that whitelist come from?</p>
<p>This is where DXR really shines. If we look at <a href="https://dxr.mozilla.org/mozilla-central/source/netwerk/base/nsIPermissionManager.idl">nsIPermissionManager.idl</a> and click the name of the interface, a dropdown appears with several options. The "Find subclasses" option performs a search for <code>"derived:nsIPermissionManager"</code>, which leads to the <a href="https://dxr.mozilla.org/mozilla-central/source/extensions/cookie/nsPermissionManager.h#32">header file for nsPermissionManager</a>.</p>
<p>We're looking for where the default permission values come from, so an in-page search for the word <code>"default"</code> eventually lands on a function named <code>ImportDefaults</code>. Clicking that name and selecting "Jump to definition" lands us inside <a href="https://dxr.mozilla.org/mozilla-central/source/extensions/cookie/nsPermissionManager.cpp?q=%2Bfunction%3AnsPermissionManager%3A%3AImportDefaults%28%29&amp;redirect_type=single#2679">nsPermissionManager.cpp</a>, and the very first line of the function is:</p>
<div class="highlight"><pre><span></span><span class="n">nsCString</span> <span class="n">defaultsURL</span> <span class="o">=</span> <span class="n">mozilla</span><span class="o">::</span><span class="n">Preferences</span><span class="o">::</span><span class="n">GetCString</span><span class="p">(</span><span class="n">kDefaultsUrlPrefName</span><span class="p">);</span>
</pre></div>
<p>An in-page search for <code>kDefaultsUrlPrefName</code> leads to:</p>
<div class="highlight"><pre><span></span><span class="c1">// Default permissions are read from a URL - this is the preference we read</span>
<span class="c1">// to find that URL. If not set, don&#39;t use any default permissions.</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">kDefaultsUrlPrefName</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;permissions.manager.defaultsUrl&quot;</span><span class="p">;</span>
</pre></div>
<p>On my Firefox profile, the <code>"permissions.manager.defaultsUrl"</code> preference is set to <a href="resource://app/defaults/permissions">resource://app/defaults/permissions</a>:</p>
<div class="highlight"><pre><span></span># This file has default permissions for the permission manager.
# The file-format is strict:
# * matchtype \t type \t permission \t host
# * &quot;origin&quot; should be used for matchtype, &quot;host&quot; is supported for legacy reasons
# * type is a string that identifies the type of permission (e.g. &quot;cookie&quot;)
# * permission is an integer between 1 and 15
# See nsPermissionManager.cpp for more...

# UITour
origin    uitour    1    https://www.mozilla.org
origin    uitour    1    https://self-repair.mozilla.org
origin    uitour    1    https://support.mozilla.org
origin    uitour    1    https://addons.mozilla.org
origin    uitour    1    https://discovery.addons.mozilla.org
origin    uitour    1    about:home

# ...
</pre></div>
<p>Found it! A quick DXR search reveals that this file is in <a href="https://dxr.mozilla.org/mozilla-central/source/browser/app/permissions">/browser/app/permissions</a> in the tree. I'm not entirely sure where that <code>defaults</code> bit in the URL is coming from, but whatever.</p>
<p>With this, we can confirm that the permissions check is where most valid uses of UITour are passed, and that this permissions file is where the whitelist of allowed domains lives.</p>
<h4>isTestingOrigin</h4>
<p>The last check in <code>ensureTrustedOrigin</code> falls back to <code>isTestingOrigin</code>:</p>
<div class="highlight"><pre><span></span><span class="nx">isTestingOrigin</span><span class="p">(</span><span class="nx">aURI</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">Services</span><span class="p">.</span><span class="nx">prefs</span><span class="p">.</span><span class="nx">getPrefType</span><span class="p">(</span><span class="nx">PREF_TEST_WHITELIST</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">Services</span><span class="p">.</span><span class="nx">prefs</span><span class="p">.</span><span class="nx">PREF_STRING</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Add any testing origins (comma-seperated) to the whitelist for the session.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">origin</span> <span class="k">of</span> <span class="nx">Services</span><span class="p">.</span><span class="nx">prefs</span><span class="p">.</span><span class="nx">getCharPref</span><span class="p">(</span><span class="nx">PREF_TEST_WHITELIST</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">testingURI</span> <span class="o">=</span> <span class="nx">Services</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">newURI</span><span class="p">(</span><span class="nx">origin</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">aURI</span><span class="p">.</span><span class="nx">prePath</span> <span class="o">==</span> <span class="nx">testingURI</span><span class="p">.</span><span class="nx">prePath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">Cu</span><span class="p">.</span><span class="nx">reportError</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">},</span>
</pre></div>
<p>Remember those boring constants we ignored earlier? Here's one of them in action! Specifically, it's <code>PREF_TEST_WHITELIST</code>, which is set to <code>"browser.uitour.testingOrigins"</code>.</p>
<p>This function appears to parse the preference as a comma-separated list of URIs. It fails early if the preference isn't a string, then splits the string and loops over each entry, converting them to URI objects.</p>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Reference/Interface/nsIURI#Components_of_a_URI">nsIURI</a> documentation notes that <code>prePath</code> is everything in the URI before the path, including the protocol, hostname, port, etc. Using <code>prePath</code>, the function iterates over each URI in the preference and checks it against the URI of the webpage. If it matches, then the page is considered safe!</p>
<p>(And if anything fails when parsing URIs, errors are reported to the console using <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Language_Bindings/Components.utils.reportError">reportError</a> and discarded.)</p>
<p>As the preference name implies, this is useful for developers who want to test a webpage that uses UITour without having to set up their local development environment to fake being one of the whitelisted origins.</p>
<h3>Sendings Messages Back to the Webpage</h3>
<p>The other remaining logic in <code>content-UITour.js</code> handles messages sent back to the content process from <code>UITour.jsm</code>:</p>
<div class="highlight"><pre><span></span><span class="nx">receiveMessage</span><span class="p">(</span><span class="nx">aMessage</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">aMessage</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s2">&quot;UITour:SendPageCallback&quot;</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sendPageEvent</span><span class="p">(</span><span class="s2">&quot;Response&quot;</span><span class="p">,</span> <span class="nx">aMessage</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s2">&quot;UITour:SendPageNotification&quot;</span><span class="o">:</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">sendPageEvent</span><span class="p">(</span><span class="s2">&quot;Notification&quot;</span><span class="p">,</span> <span class="nx">aMessage</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">},</span>
</pre></div>
<p>You may remember the <a href="https://developer.mozilla.org/en-US/Firefox/Multiprocess_Firefox/Message_Manager/Message_manager_overview">Message manager overview</a>, which links to documentation for several functions, including <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Reference/Interface/nsIMessageListenerManager#addMessageListener()">addMessageListener</a>. We passed in <code>UITourListener</code> as the listener, which the documentation says should implement the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Reference/Interface/nsIMessageListener">nsIMessageListener</a> interface. Thus, <code>UITourListener.receiveMessage</code> is called whenever messages are received from <code>UITour.jsm</code>.</p>
<p>The function itself is simple; it defers to <code>sendPageEvent</code> with slightly different parameters depending on the incoming message.</p>
<div class="highlight"><pre><span></span><span class="nx">sendPageEvent</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">detail</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ensureTrustedOrigin</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">doc</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nb">document</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">eventName</span> <span class="o">=</span> <span class="s2">&quot;mozUITour&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">event</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">defaultView</span><span class="p">.</span><span class="nx">CustomEvent</span><span class="p">(</span><span class="nx">eventName</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">bubbles</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">detail</span><span class="o">:</span> <span class="nx">Cu</span><span class="p">.</span><span class="nx">cloneInto</span><span class="p">(</span><span class="nx">detail</span><span class="p">,</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">defaultView</span><span class="p">)</span>
  <span class="p">});</span>
  <span class="nx">doc</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p><code>sendPageEvent</code> starts off with another trusted origin check, to avoid sending results from UITour to untrusted webpages. Next, it creates a custom event to dispatch onto the document element of the webpage. Webpages register an event listener on the root document element to receive data returned from UITour.</p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/defaultView"><code>defaultView</code></a> returns the window object for the document in question.</p>
<p>Describing <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Language_Bindings/Components.utils.cloneInto"><code>cloneInto</code></a> could take up an entire post on its own. In short, <code>cloneInto</code> is being used here to copy the object from UITour in the chrome process (a privileged context) for use in the webpage (an unprivileged context). Without this, the webpage would not be able to access the <code>detail</code> value at all.</p>
<h3>And That's It!</h3>
<p>It takes effort, but I've found that deep-dives like this are a great way to both understand a single piece of code, and to learn from the style of the code's author(s). Hopefully ya'll will find this useful as well!</p>
<div class="footnotes">
<hr>
<ol><li id="fn-1"><p>While this isn't a security issue on its own, it gives some level of control to an attacker, which generally should be avoided where possible.<a href="#fnref-1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

  </div>

  
    
  <div class="blog-post">
  
    <h2 class="blog-title"><a href="../blog/caching-async-operations-via-promises/">Caching Async Operations via Promises</a></h2>
  
  <div class="meta">
    <span>
      <i class="octicon octicon-calendar"></i>
      August 22, 2016
    </span>
    <span>
      <i class="octicon octicon-tag"></i>
      mozilla
    </span>
  </div>
  <p>I was working on <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1293475">a bug in Normandy</a> the other day and remembered a fun little trick for caching asynchronous operations in JavaScript.</p>
<p>The bug in question involved two asynchronous actions happening within a function. First, we made an AJAX request to the server to get an "Action" object. Next, we took an attribute of the action, the <code>implementation_url</code>, and injected a <code>&lt;script&gt;</code> tag into the page with the <code>src</code> attribute set to the URL. The JavaScript being injected would then call a global function and pass it a class function, which was the value we wanted to return.</p>
<p>The bug was that if we called the function multiple times with the same action, the function would make multiple requests to the same URL, even though we really only needed to download data for each Action once. The solution was to cache the responses, but instead of caching the responses directly, I found it was cleaner to cache the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> returned when making the request instead:</p>
<div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">fetchAction</span><span class="p">(</span><span class="nx">recipe</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">fetchAction</span><span class="p">.</span><span class="nx">_cache</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">recipe</span><span class="p">.</span><span class="nx">action</span> <span class="k">in</span> <span class="nx">cache</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">cache</span><span class="p">[</span><span class="nx">recipe</span><span class="p">.</span><span class="nx">action</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">(</span><span class="sb">`/api/v1/action/</span><span class="si">${</span><span class="nx">recipe</span><span class="p">.</span><span class="nx">action</span><span class="si">}</span><span class="sb">/`</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="p">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">recipe</span><span class="p">.</span><span class="nx">action</span><span class="p">];</span>
<span class="p">}</span>
<span class="nx">fetchAction</span><span class="p">.</span><span class="nx">_cache</span> <span class="o">=</span> <span class="p">{};</span>
</pre></div>
<p>Another neat trick in the code above is storing the cache as a property on the function itself; it helps avoid polluting the namespace of the module, and also allows callers to clear the cache if they wish to force a re-fetch (although if you actually needed that, it'd be better to add a parameter to the function instead).</p>
<p>After I got this working, I puzzled for a bit on how to achieve something similar for the <code>&lt;script&gt;</code> tag injection. Unlike an AJAX request, the only thing I had to work with was an <code>onload</code> handler for the tag. Eventually I realized that nothing was stopping me from wrapping the <code>&lt;script&gt;</code> tag injection in a Promise and caching it in exactly the same way:</p>
<div class="highlight"><pre><span></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">loadActionImplementation</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">loadActionImplementation</span><span class="p">.</span><span class="nx">_cache</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">cache</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">cache</span><span class="p">[</span><span class="nx">action</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
      <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">action</span><span class="p">.</span><span class="nx">implementation_url</span><span class="p">;</span>
      <span class="nx">script</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">registeredActions</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="sb">`Could not find action with name </span><span class="si">${</span><span class="nx">action</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">.`</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">(</span><span class="nx">registeredActions</span><span class="p">[</span><span class="nx">action</span><span class="p">.</span><span class="nx">name</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">};</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">action</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
<span class="p">}</span>
<span class="nx">loadActionImplementation</span><span class="p">.</span><span class="nx">_cache</span> <span class="o">=</span> <span class="p">{};</span>
</pre></div>
<p>From a nitpicking standpoint, I'm not entirely happy with this function:</p>
<ul>
<li>The name isn't really consistent with the "fetch" terminology from the previous function, but I'm not convinced they should use the same verb either.</li>
<li>The Promise code could probably live in another function, leaving this one to only concern itself about the caching.</li>
<li>I'm pretty sure this does nothing to handle the case of the script failing to load, like a 404.</li>
</ul>
<p>But these are minor, and the patch got merged, so I guess it's good enough.</p>

  </div>

  

  
  <div class="pagination">
    
      <span class="disabled">&laquo; Previous</span>
    
    | 1 |
    
      <span class="disabled">Next &raquo;</span>
    
  </div>


  </div>
  <footer>
    &copy; Copyright 2016 by Michael Kelly.
  </footer>
</body>
</html>
